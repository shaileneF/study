<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/icon/111.ico"><title>Flink基本篇2 | shAilene</title><meta name="description" content="just be simple.">
    <link rel="modulepreload" href="/study/assets/app.4e5a7100.js"><link rel="modulepreload" href="/study/assets/flink基本篇2.html.c7d8048a.js"><link rel="modulepreload" href="/study/assets/flink基本篇2.html.6e89c1e9.js"><link rel="prefetch" href="/study/assets/index.html.cc085cf1.js"><link rel="prefetch" href="/study/assets/index.html.763c73a0.js"><link rel="prefetch" href="/study/assets/index.html.074760ca.js"><link rel="prefetch" href="/study/assets/index.html.ff759a47.js"><link rel="prefetch" href="/study/assets/index.html.dde20e30.js"><link rel="prefetch" href="/study/assets/index.html.f18f6eeb.js"><link rel="prefetch" href="/study/assets/index.html.3b4ee2ac.js"><link rel="prefetch" href="/study/assets/设计模式1.html.d254a4fb.js"><link rel="prefetch" href="/study/assets/设计模式2.html.c1bb479a.js"><link rel="prefetch" href="/study/assets/gin.html.d64dfd47.js"><link rel="prefetch" href="/study/assets/golang.html.16099e4e.js"><link rel="prefetch" href="/study/assets/gorm.html.18769af2.js"><link rel="prefetch" href="/study/assets/Javaweb.html.6822767e.js"><link rel="prefetch" href="/study/assets/docker.html.5ab0d932.js"><link rel="prefetch" href="/study/assets/ES.html.79218e9b.js"><link rel="prefetch" href="/study/assets/kafka.html.9d038d97.js"><link rel="prefetch" href="/study/assets/vue基础.html.e141ee41.js"><link rel="prefetch" href="/study/assets/vue组件.html.4748d6a7.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.798adcda.js"><link rel="prefetch" href="/study/assets/Java笔记.html.3daff183.js"><link rel="prefetch" href="/study/assets/dubbo.html.54518c15.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.f9694838.js"><link rel="prefetch" href="/study/assets/springcloud（下）.html.8ddee628.js"><link rel="prefetch" href="/study/assets/zookeeper.html.5728d718.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.096bbe6f.js"><link rel="prefetch" href="/study/assets/并发编程.html.4e11253b.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.4b7a32bc.js"><link rel="prefetch" href="/study/assets/redis.html.098d7b82.js"><link rel="prefetch" href="/study/assets/Mybatis.html.bef8c38c.js"><link rel="prefetch" href="/study/assets/spring.html.728ddcf2.js"><link rel="prefetch" href="/study/assets/springboot.html.515b4e7b.js"><link rel="prefetch" href="/study/assets/springboot.html.74edc301.js"><link rel="prefetch" href="/study/assets/springMVC.html.43a301bd.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.9428006f.js"><link rel="prefetch" href="/study/assets/操作系统.html.ddd809ec.js"><link rel="prefetch" href="/study/assets/flink基本篇1.html.585b5f0e.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.5c5c9afa.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.62932cc9.js"><link rel="prefetch" href="/study/assets/404.html.93146c89.js"><link rel="prefetch" href="/study/assets/index.html.9941bc88.js"><link rel="prefetch" href="/study/assets/index.html.ba4d5cb6.js"><link rel="prefetch" href="/study/assets/index.html.92c2648f.js"><link rel="prefetch" href="/study/assets/index.html.275631af.js"><link rel="prefetch" href="/study/assets/index.html.dce06860.js"><link rel="prefetch" href="/study/assets/index.html.12c7d9e3.js"><link rel="prefetch" href="/study/assets/index.html.64017171.js"><link rel="prefetch" href="/study/assets/设计模式1.html.f9509174.js"><link rel="prefetch" href="/study/assets/设计模式2.html.1448346a.js"><link rel="prefetch" href="/study/assets/gin.html.e84e137e.js"><link rel="prefetch" href="/study/assets/golang.html.9f2a4ad8.js"><link rel="prefetch" href="/study/assets/gorm.html.29c23928.js"><link rel="prefetch" href="/study/assets/Javaweb.html.b8b69904.js"><link rel="prefetch" href="/study/assets/docker.html.f9b87572.js"><link rel="prefetch" href="/study/assets/ES.html.e50fa5be.js"><link rel="prefetch" href="/study/assets/kafka.html.bf129f92.js"><link rel="prefetch" href="/study/assets/vue基础.html.632361f6.js"><link rel="prefetch" href="/study/assets/vue组件.html.99d0cd49.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.4d54b2ed.js"><link rel="prefetch" href="/study/assets/Java笔记.html.94eb4cc9.js"><link rel="prefetch" href="/study/assets/dubbo.html.faf3ca04.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.c74a33f2.js"><link rel="prefetch" href="/study/assets/springcloud（下）.html.2efcab09.js"><link rel="prefetch" href="/study/assets/zookeeper.html.b129f230.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.3629803c.js"><link rel="prefetch" href="/study/assets/并发编程.html.4dbc83ff.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.7a23c582.js"><link rel="prefetch" href="/study/assets/redis.html.fa43852e.js"><link rel="prefetch" href="/study/assets/Mybatis.html.319d9304.js"><link rel="prefetch" href="/study/assets/spring.html.08488cf6.js"><link rel="prefetch" href="/study/assets/springboot.html.7dea3ce4.js"><link rel="prefetch" href="/study/assets/springboot.html.ac553e9e.js"><link rel="prefetch" href="/study/assets/springMVC.html.bcee5852.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.68fd4ad6.js"><link rel="prefetch" href="/study/assets/操作系统.html.7226aca8.js"><link rel="prefetch" href="/study/assets/flink基本篇1.html.26f7d4ae.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.3e94b54b.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.27393be1.js"><link rel="prefetch" href="/study/assets/404.html.085ef4ab.js"><link rel="prefetch" href="/study/assets/404.65bb6fca.js"><link rel="prefetch" href="/study/assets/Layout.a12f3a75.js">
    <link rel="stylesheet" href="/study/assets/style.2bba04cf.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/study/" class=""><img class="logo" src="/study/images/leo.jpg" alt="shAilene"><span class="site-name can-hide">shAilene</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/study/计算机基础/" class="" aria-label="计算机基础"><!--[--><!--]--> 计算机基础 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/前端/" class="" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/study/计算机基础/" class="" aria-label="计算机基础"><!--[--><!--]--> 计算机基础 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/前端/" class="" aria-label="前端"><!--[--><!--]--> 前端 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Flink基本篇2 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#第五章-flink运行时架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="第五章 Flink运行时架构"><!--[--><!--]--> 第五章 Flink运行时架构 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#作业管理器" class="router-link-active router-link-exact-active sidebar-item" aria-label="作业管理器"><!--[--><!--]--> 作业管理器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#job-master" class="router-link-active router-link-exact-active sidebar-item" aria-label="Job master"><!--[--><!--]--> Job master <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#资源管理器" class="router-link-active router-link-exact-active sidebar-item" aria-label="资源管理器"><!--[--><!--]--> 资源管理器 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#任务管理器-task-manager" class="router-link-active router-link-exact-active sidebar-item" aria-label="任务管理器 task manager"><!--[--><!--]--> 任务管理器 task manager <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#作业提交流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="作业提交流程"><!--[--><!--]--> 作业提交流程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#思考" class="router-link-active router-link-exact-active sidebar-item" aria-label="思考"><!--[--><!--]--> 思考 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#一些重要概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="一些重要概念"><!--[--><!--]--> 一些重要概念 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#并行度" class="router-link-active router-link-exact-active sidebar-item" aria-label="并行度"><!--[--><!--]--> 并行度 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#数据传输形式" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据传输形式"><!--[--><!--]--> 数据传输形式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#执行图" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行图"><!--[--><!--]--> 执行图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#任务和任务槽" class="router-link-active router-link-exact-active sidebar-item" aria-label="任务和任务槽"><!--[--><!--]--> 任务和任务槽 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#第六章-datastream-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="第六章 Datastream API"><!--[--><!--]--> 第六章 Datastream API <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#执行环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行环境"><!--[--><!--]--> 执行环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#源算子" class="router-link-active router-link-exact-active sidebar-item" aria-label="源算子"><!--[--><!--]--> 源算子 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#准备工作" class="router-link-active router-link-exact-active sidebar-item" aria-label="准备工作"><!--[--><!--]--> 准备工作 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#读取数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="读取数据"><!--[--><!--]--> 读取数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#从kafka读取数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="从kafka读取数据"><!--[--><!--]--> 从kafka读取数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#自定义source" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义source"><!--[--><!--]--> 自定义source <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#自定义并行source" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义并行source"><!--[--><!--]--> 自定义并行source <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#flink支持的数据类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="flink支持的数据类型"><!--[--><!--]--> flink支持的数据类型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#转换算子-transformation" class="router-link-active router-link-exact-active sidebar-item" aria-label="转换算子（Transformation）"><!--[--><!--]--> 转换算子（Transformation） <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#map" class="router-link-active router-link-exact-active sidebar-item" aria-label="map"><!--[--><!--]--> map <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#filter" class="router-link-active router-link-exact-active sidebar-item" aria-label="filter"><!--[--><!--]--> filter <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#flatmap" class="router-link-active router-link-exact-active sidebar-item" aria-label="flatMap"><!--[--><!--]--> flatMap <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#聚合算子" class="router-link-active router-link-exact-active sidebar-item" aria-label="聚合算子"><!--[--><!--]--> 聚合算子 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#用户自定义函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="用户自定义函数"><!--[--><!--]--> 用户自定义函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#chatgpt-keyby分流再合流的用法" class="router-link-active router-link-exact-active sidebar-item" aria-label="ChatGpt keyBy分流再合流的用法"><!--[--><!--]--> ChatGpt keyBy分流再合流的用法 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#物理分区" class="router-link-active router-link-exact-active sidebar-item" aria-label="物理分区"><!--[--><!--]--> 物理分区 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#输出算子" class="router-link-active router-link-exact-active sidebar-item" aria-label="输出算子"><!--[--><!--]--> 输出算子 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#输出到文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="输出到文件"><!--[--><!--]--> 输出到文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#输出到kafka" class="router-link-active router-link-exact-active sidebar-item" aria-label="输出到kafka"><!--[--><!--]--> 输出到kafka <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#第七章-时间和窗口" class="router-link-active router-link-exact-active sidebar-item" aria-label="第七章 时间和窗口"><!--[--><!--]--> 第七章 时间和窗口 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#时间语义" class="router-link-active router-link-exact-active sidebar-item" aria-label="时间语义"><!--[--><!--]--> 时间语义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#水位线" class="router-link-active router-link-exact-active sidebar-item" aria-label="水位线"><!--[--><!--]--> 水位线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#窗口" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口"><!--[--><!--]--> 窗口 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="概念"><!--[--><!--]--> 概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#分类" class="router-link-active router-link-exact-active sidebar-item" aria-label="分类"><!--[--><!--]--> 分类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#窗口api" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口API"><!--[--><!--]--> 窗口API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#窗口分配器" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口分配器"><!--[--><!--]--> 窗口分配器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#窗口函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口函数"><!--[--><!--]--> 窗口函数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#第八章-分流合流" class="router-link-active router-link-exact-active sidebar-item" aria-label="第八章 分流合流"><!--[--><!--]--> 第八章 分流合流 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%872.html#分流" class="router-link-active router-link-exact-active sidebar-item" aria-label="分流"><!--[--><!--]--> 分流 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="flink基本篇2" tabindex="-1"><a class="header-anchor" href="#flink基本篇2" aria-hidden="true">#</a> Flink基本篇2</h1><h2 id="第五章-flink运行时架构" tabindex="-1"><a class="header-anchor" href="#第五章-flink运行时架构" aria-hidden="true">#</a> 第五章 Flink运行时架构</h2><h3 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h3><p>通常，我们只需要使用getExecutionEnvironment()，因为这将根据上下文执行正确的操作：如果你是在IDE中执行程序或作为常规Java程序执行，它将创建一个本地环境，该环境将在本地计算机上执行您的程序。如果您是从程序创建的JAR文件，并通过命令行调用它，则Flink集群管理器将执行您的main方法，而getExecutionEnvironment()将返回用于在集群上执行程序的执行环境。</p><p>Task Slot就是任务槽，就是执行任务所需的最小的一块资源。</p><p>flink客户端并不是运行时系统的一部分，只是起了一个提交作业的作用。</p><p>对于运行时系统而言，主要就由job manager和task manager组成。</p><h3 id="作业管理器" tabindex="-1"><a class="header-anchor" href="#作业管理器" aria-hidden="true">#</a> 作业管理器</h3><p><strong>控制一个应用程序执行的主进程</strong>，是Flink集群中任务管理和调度的核心。</p><h4 id="job-master" tabindex="-1"><a class="header-anchor" href="#job-master" aria-hidden="true">#</a> Job master</h4><p>是Job manager中最核心的组件，<strong>一个job 对应于一个job master</strong>。</p><p>在作业提交时，Job Master会先接收到要执行的应用。一般是由客户端提交来的，包括jar包，数据流图（dataflow graph）和作业图（job graph）。</p><p>job master会把jobGraph转换成一个物理层面的数据流图，这个图被称为执行图，它包含了所有可以并发执行的任务，job master会向资源管理器发出请求，申请执行任务必要的资源，一旦获得了足够的资源，就会将执行图分发到真正运行他们的task manager上。</p><h4 id="资源管理器" tabindex="-1"><a class="header-anchor" href="#资源管理器" aria-hidden="true">#</a> 资源管理器</h4><p>资源管理器主要负责资源的分配和管理，<strong>在flink集群中只有一个</strong>。所谓资源就是task manager的任务槽，任务槽就是flink集群的资源调配单元，包含了机器用来执行作业的一组CPU和内存资源。每一个任务task都需要分配到一个slot上执行。</p><h3 id="任务管理器-task-manager" tabindex="-1"><a class="header-anchor" href="#任务管理器-task-manager" aria-hidden="true">#</a> 任务管理器 task manager</h3><p>flink的工作进程，通常在flink集群中会有多个task manager运行，每一个task manager都包含了一定数量的slots。slots的数量限制了task manager能够并行处理的任务数量。</p><h3 id="作业提交流程" tabindex="-1"><a class="header-anchor" href="#作业提交流程" aria-hidden="true">#</a> 作业提交流程</h3><p>standalone模式</p><p><img src="/study/assets/image-20230406165402400.442b2001.png" alt="image-20230406165402400"></p><p>yarn会话模式</p><p>task manager跑在容器里</p><p><img src="/study/assets/image-20230406170036021.b51cd847.png" alt="image-20230406170036021"></p><h4 id="思考" tabindex="-1"><a class="header-anchor" href="#思考" aria-hidden="true">#</a> 思考</h4><p>一个流处理程序，到底包含多少个任务？</p><p>最终执行任务，需要占用多少slot？</p><p>所有flink程序都是由三部分组成的：source、transformation和sink</p><p>source负责读取数据源，transformation利用各种算子进行处理加工，sink负责输出。</p><h3 id="一些重要概念" tabindex="-1"><a class="header-anchor" href="#一些重要概念" aria-hidden="true">#</a> 一些重要概念</h3><h4 id="并行度" tabindex="-1"><a class="header-anchor" href="#并行度" aria-hidden="true">#</a> 并行度</h4><p>每一个算子（operator）可以包含一个或多个子任务，这些子任务在不同的线程、不同的物理机或不同的容器中<strong>完全独立地执行（在不同的task manager slot中执行）。</strong></p><p>一个特定算子的子任务的个数被称之为这个算子的并行度。</p><p><strong>一个作业里面的不同算子可以设置不同的并行度。并行度是针对每个特定算子而言的。</strong></p><p>env也可以设置并行度，表示全局的所有算子的并行度。</p><p>如果在env设置了并行度，在后面的算子处又设置了并行度，那么优先级是算子本身的并行度优先级最高。</p><p>优先级：</p><p>每个算子的并行度设置 &gt; env环境的并行度设置 &gt; 作业提交的并行度设置</p><p>一个流处理程序，可以认为是一个作业，一个作业提交后，不等于一个任务，而是多个子任务，每一个任务会到task manager的一个slot执行。具体是多少子任务，这取决于并行度的设置。</p><h4 id="数据传输形式" tabindex="-1"><a class="header-anchor" href="#数据传输形式" aria-hidden="true">#</a> 数据传输形式</h4><p>One-To-One</p><p>stream维护着分区以及元素的顺序，比如source和map之间，这意味着map算子的子任务看到的元素的个数以及顺序和source算子的子任务生产的元素的个数、顺序相同。map、filter、flatmap都是One-To-One的关系。</p><p>算子链怎么合并：</p><p>前后发生的两个算子之间是One-To-One的关系，且算子的并行度相同，那么可以合并成一个算子链，在拓扑图中可以看到。可以节省开销。</p><p><img src="/study/assets/image-20230407154008166.550f85ce.png" alt="image-20230407154008166"></p><h4 id="执行图" tabindex="-1"><a class="header-anchor" href="#执行图" aria-hidden="true">#</a> 执行图</h4><p>flink中的执行图可以分为四层：</p><ul><li>StreamGraph</li><li>JobGraph</li><li>ExecutionGraph</li><li>物理执行图</li></ul><p>StreamGraph：是根据用户通过Stream API编写的代码生成的最初的图，用来表示程序的拓扑结构。</p><p>JobGraph：StreamGraph经过优化后，生成了JobGraph，提交给JobManager的数据结构，主要的优化为，将多个符合条件的节点chain在一起作为一个节点（合并成算子链），节省开销。</p><p>ExecutionGraph：JobManager根据JobGraph生成的图，ExecutionGraph是JobGraph的<strong>并行化版本</strong>，是调度层最核心的数据结构。</p><h4 id="任务和任务槽" tabindex="-1"><a class="header-anchor" href="#任务和任务槽" aria-hidden="true">#</a> 任务和任务槽</h4><p>flink中每一个task manager都是一个JVM进程，为了控制一个task manager能接收多少task，task manager通过task slot来进行控制（一个task manager至少有一个slot）</p><p>slot是对资源的一种划分。</p><p>slot的隔离主要是针对内存。</p><p><strong>配置task manager的slot数量的时候，建议按cpu的核心数量来配置，一个slot分配给一个核，这样CPU就不用分时复用了。</strong></p><p>为什么5个任务，用两个slot就跑起来了？</p><p>是因为在flink里面，任务之间默认是可以进行slot共享的。</p><p>同一个算子的并行子任务，在不同的slot执行；不同算子的任务，有先后顺序的任务，可以共用同一个slot</p><p><img src="/study/assets/image-20230407160017643.c2a4b9cd.png" alt="image-20230407160017643"></p><p>这样的结果是，一个slot可以保存作业的整个管道。</p><p>要配置slot数量和并行度，保证资源的充分利用。</p><h2 id="第六章-datastream-api" tabindex="-1"><a class="header-anchor" href="#第六章-datastream-api" aria-hidden="true">#</a> 第六章 Datastream API</h2><p>flink新版本已经实现了流批一体，DataSet API将被弃用，官方推荐统一使用Datastream API来处理流数据和批数据。</p><p>Datastream本身是一个flink中用来表示数据集合的类，我们编写的flink代码其实就是基于这种数据类型的处理。我们用一系列API来处理这个集合中的数据，这就叫做数据流的transformations。</p><p>一个flink程序，其实就是对Datastream的各种转换，具体来说，代码基本上都由以下几部分构成</p><ul><li>获取执行环境</li><li>读取数据源</li><li>定义基于数据的转换操作</li><li>定义计算结果的输出位置</li><li>触发程序执行</li></ul><h3 id="执行环境" tabindex="-1"><a class="header-anchor" href="#执行环境" aria-hidden="true">#</a> 执行环境</h3><p>创建执行环境</p><p>最简单的方式，就是直接调用getExecutionEnvironment方法，它会根据当前运行的上下文直接得到正确的结果。如果程序是独立运行的，就返回一个本地执行环境；如果是打包成了jar包，然后提交到集群执行，那么就返回集群执行环境。也就是说这个方法会根据当前运行的方式，自行决定该返回什么样的执行环境。</p><p>在获取到执行环境后，我们可以对执行环境进行设置，比如可以设置全局并行度，禁用算子链等。</p><h3 id="源算子" tabindex="-1"><a class="header-anchor" href="#源算子" aria-hidden="true">#</a> 源算子</h3><p>首要任务就是把数据读进来。</p><p>用来读取数据源的算子就叫源算子。source是整个处理程序的输入端。</p><p>flink代码中通用的添加source的方式，就是调用执行环境的addSource方法</p><p>在实际工作中，我们基本不会碰到很简单的数据类型，不会有很简单的应用需求。需要处理的数据往往是具有多个字段的数据类型。所以我们一般情况会把处理数据包装成元组类型或者说POJO对象，方便后面的处理和转换。</p><p>为了更好地理解，先构建一个实际应用场景，比如网站的访问操作，可以抽象成一个三元组（用户名、用户访问的url，用户访问url的时间戳），所以在这里，我们可以创建一个类Event，将用户行为包装成一个对象。这个对象包含上述的三个字段。</p><h4 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h4><ol><li><p>准备POJO</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>wc<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>diskData</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Timestamp</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> user<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Event{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;user=&#39;&quot;</span> <span class="token operator">+</span> user <span class="token operator">+</span> <span class="token char">&#39;\&#39;&#39;</span> <span class="token operator">+</span>
                <span class="token string">&quot;, url=&#39;&quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token char">&#39;\&#39;&#39;</span> <span class="token operator">+</span>
                <span class="token string">&quot;, timestamp=&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token char">&#39;}&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义的POJO，有这样几个特点：</p><ul><li>类是公有的</li><li>有一个无参的构造方法</li><li>所有属性都是公有的</li><li>所有属性的类型都是可以序列化的</li></ul><p>flink会把这样的类作为一种特殊的POJO数据类型来对待，方便数据的解析和序列化。另外我们还在类中重写了toString 方法，主要是为了测试输出显示更清晰。</p></li></ol><h4 id="读取数据" tabindex="-1"><a class="header-anchor" href="#读取数据" aria-hidden="true">#</a> 读取数据</h4><p>根据上面的知识已经知道，一个main启动类里面，source算子可以有多个，也就是数据来源可以有多个。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1. 从文件中读取数据，readTextFile，在实际工作中也很常用，读取日志文件中的数据</span>
        <span class="token comment">// 当然结合flume + kafka，可以将日志文件中的数据做清洗，生产到kafka中，将kafka作为flink的数据源。</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream1 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">&quot;input/clicks.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2. 从集合中读取数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> nums <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nums<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nums<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DataStreamSource泛型里面的类型就是我们当前传入的数据类型</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> numStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream2 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 从元素读取数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream3 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 从socket文本流读取</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream4 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.14.131&quot;</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        stream1.print(&quot;1&quot;);</span>
<span class="token comment">//        numStream.print(&quot;nums&quot;);</span>
<span class="token comment">//        stream2.print(&quot;2&quot;);</span>
        stream4<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="从kafka读取数据" tabindex="-1"><a class="header-anchor" href="#从kafka读取数据" aria-hidden="true">#</a> 从kafka读取数据</h4><p>上面读取的数据都是有界流，从内存列表读，从文件读，都是有界流。从socket读适合吞吐量不大，做测试的时候。</p><p>对于真正的流数据，实际项目应该怎样读取呢？</p><p>kafka作为分布式消息队列，是一个高吞吐、易于扩展的消息系统。而消息队列的传输方式，恰恰与流处理是一致的，所以说kafka和flink可以说是天生一对。</p><p>在如今的实时流处理应用中，由kafka进行数据的收集和传输，flink进行分析计算，这样的架构已成为众多企业的首选。</p><p>需要引入kafka连接器</p><div class="language-pom ext-pom"><pre class="language-pom"><code>    &lt;!--kafka--&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
      &lt;artifactId&gt;flink-connector-kafka_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;${flink.version}&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xxxxxx:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token string">&quot;clicks&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="自定义source" tabindex="-1"><a class="header-anchor" href="#自定义source" aria-hidden="true">#</a> 自定义source</h4><p>创建自定义的数据源，实现SourceFunction接口，主要重写两个关键方法：run()和cancel()</p><ul><li><p>run()：</p><p>使用运行时上下文对象（SourceContext）向下游发送数据</p><p>run方法里面设置一个标志位</p></li><li><p>cancel()</p><p>取消当前作业，将标志位改为false</p></li></ul><p>定义一个随机生成数据的sourceFuntion，注意要指定泛型，也就是数据源的类型</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClickSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 声明一个标志位</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定义随机生成数据</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 定义生成随机数据选取的字段</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;Marry&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cary&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urls <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./fav&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=10&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 循环生成数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> user <span class="token operator">=</span> users<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> url <span class="token operator">=</span> urls<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimeInMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> url<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//main</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SourceCustomTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义source function</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> customDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClickSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        customDataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这种用户自定义数据源的方法，可以很好地用于测试。</p><p>如果自定义的sourceFunction不是并行sourceFunction，则不能设置source算子的并行度，对于非并行sourceFunction的并行度，只能设置为1.</p><h4 id="自定义并行source" tabindex="-1"><a class="header-anchor" href="#自定义并行source" aria-hidden="true">#</a> 自定义并行source</h4><div class="language-java ext-java"><pre class="language-java"><code>    <span class="token comment">// 实现自定义的并行sourceFunction</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ParallelCustomSource</span> <span class="token keyword">implements</span> <span class="token class-name">ParallelSourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Boolean</span> running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>对于这个自定义的并行数据源就可以给source设置并行度了。</p><h4 id="flink支持的数据类型" tabindex="-1"><a class="header-anchor" href="#flink支持的数据类型" aria-hidden="true">#</a> flink支持的数据类型</h4><p>flink支持的数据类型有Java所有的基本类型及其包装类，再加上void，String，Date，BigDecimal和BigInteger</p><p>支持数组类型，包括基本类型数组和对象数组</p><p>复合数据类型</p><ul><li>Java元组类型（Tuple0-Tuple25）</li><li>Scala样例类及Scala元组</li><li>行类型，可以认为是具有任意个字段的元组</li><li>POJO</li></ul><p>flink对POJO类型要求如下：</p><ul><li>类是public的且独立的，没有非静态的内部类。</li><li>类有一个公共的无参构造方法</li><li>类中所有字段是public且非final的，可以直接访问到；或者有公告的getter和setter方法。</li></ul><p>flink还支持List、Map等辅助类型。</p><p>在这些类型中，元组类型和POJO类型最灵活，因为他们支持创建复杂类型，而相比之下，POJO还支持在键的定义中直接使用字段名，所以在实际项目中，往往会将流处理程序中的元素类型定义为Flink中的POJO类型。</p><h3 id="转换算子-transformation" tabindex="-1"><a class="header-anchor" href="#转换算子-transformation" aria-hidden="true">#</a> 转换算子（Transformation）</h3><p><img src="/study/assets/image-20230410105353234.a41191ce.png" alt="image-20230410105353234"></p><p>数据源读入数据之后，我们就可以使用各种转换算子，将一个或多个DataStream转换为新的DataStream，一个Flink程序的核心，其实就是所有的转换操作，他们决定了处理的业务逻辑。</p><p>可以针对一条流进行转换处理，也可以进行分流、合流等多流转换操作。</p><h4 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> map</h4><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformMapTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 自定义map function</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyMapper</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> event<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="filter" tabindex="-1"><a class="header-anchor" href="#filter" aria-hidden="true">#</a> filter</h4><p>顾名思义就是对数据流做一个过滤操作，通过一个布尔条件表达式设置一个过滤条件，对每一个流内元素进行判断。</p><p>filter转换需要传入的参数需要实现FilterFunction接口。</p><div class="language-java ext-java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="flatmap" tabindex="-1"><a class="header-anchor" href="#flatmap" aria-hidden="true">#</a> flatMap</h4><p>可以看作前面两步操作的结合。</p><p>主要是将数据流中的整体（一般是集合类型）拆分成一个个的个体使用，可以产生0到多个元素。</p><p>flatMap也可以使用Lambda表达式或者FlatMapFunction接口实现类的方式来进行传参，返回值类型可以与原数据流相同，也可以不同。</p><p>FlatMapFunction泛型两个参数分别是输入数据的数据类型和输出数据的数据类型</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformFlatMapTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyFlatMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyFlatMap</span> <span class="token keyword">implements</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="聚合算子" tabindex="-1"><a class="header-anchor" href="#聚合算子" aria-hidden="true">#</a> 聚合算子</h4><p>聚合操作，计算的结果不仅依赖于当前数据，还跟之前的数据有关，相当于要把所有数据聚在一起进行汇总合并，这就是aggregation，也对应着MapReduce中的Reduce。</p><ol><li><p>按键分区-keyBy</p><p>对于Flink而言，DataStream是没有直接进行聚合的API的，<strong>因为我们对海量数据做聚合肯定要进行分区并行处理，这样才能提高效率。</strong></p><p><strong>所以在Flink中要做聚合，先要进行分区，这个操作就是通过keyBy来完成的。</strong></p><p>这里所说的分区是逻辑上的分区。基于key分区的数据有可能被划分到物理上不同的分区，即不同task manager的不同slot。</p><p>flink的keyBy分区，是基于key的哈希值。所以这里如果key是POJO的话，那么必须重写POJO的hashCode()方法。</p><p><img src="/study/assets/image-20230410114233386.b330fc96.png" alt="image-20230410114233386"></p><p>有很多不同的方法来指定key，比如对于Tuple数据类型，可以指定字段的位置或者多个位置的组合；<strong>对于POJO类型，可以指定字段的名称；另外，还可以传入Lambda表达式，或者实现一个键选择器KeySelector，用于说明从数据提取key的逻辑。</strong></p></li><li><p>简单聚合</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformSimpleAggTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//按键分组之后进行聚合, 提取用户最近一次访问数据</span>
        <span class="token comment">// 我们要选择user作为key，那么key类型就是String</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> event<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> result1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;max:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result1<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;maxBy:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>max只针对指定的字段，maxBy则会输出整条数据，也包括其他字段。</p><p>简单聚合可以分为两步：1.keyBy；2.聚合</p></li><li><p>归约聚合</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token class-name">T</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">T</span> var1<span class="token punctuation">,</span> <span class="token class-name">T</span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
</code></pre></div><p>var1表示已经归约好的结果，这就是有状态的处理。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformReduceTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 统计最活跃的用户是谁</span>
        <span class="token comment">// 1. 统计每个用户的访问频次</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> clicksByUser <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 把两个要归约的值叠加起来，那么就是把value1和value2的第二个字段叠加起来</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> value1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 根据统计的访问频次，选择最活跃的用户</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> clicksByUser<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>value1<span class="token punctuation">.</span>f1 <span class="token operator">&gt;</span> value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> value1<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> value2<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="用户自定义函数" tabindex="-1"><a class="header-anchor" href="#用户自定义函数" aria-hidden="true">#</a> 用户自定义函数</h4><p>富函数类</p><p>所有的Flink函数类都有其Rich版本，富函数类一般是以抽象类的形式出现的。与常规函数类的不同主要在于，富函数类<strong>可以获取运行函数的上下文</strong>，并拥有一些生命周期方法。</p><p>生命周期的概念在编程中其实非常重要。比如对象的生命周期，涉及垃圾回收、内存管理等。</p><p>RichFunction有生命周期的概念，典型的<strong>生命周期方法</strong>有：</p><ul><li><p>open()</p><p>当前任务实例被创建的时候首先会调用的方法。</p><p>是RichFunction的初始化方法，也就是会开启一个算子的生命周期。**当一个算子的实际工作方法例如map()或者filter()被调用之前，open()会被首先调用。**所以像文件IO的创建，数据库连接的创建，配置文件读取等这样的操作，适合在open()方法中完成。</p></li><li><p>close()</p><p>生命周期的最后一个方法，用来做一些清理和资源释放工作。</p></li></ul><p>继承富函数类，除了实际工作方法需要重写之外，也要写生命周期方法。</p><p>生命周期方法只会被调用一次，实际工作方法，每次数据到来都会被调用。</p><div class="language-java ext-java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyRichMapper</span> <span class="token keyword">extends</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;open生命周期被调用，第&quot;</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;号任务启动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">event<span class="token punctuation">.</span>url<span class="token punctuation">.</span></span>Length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;close生命周期被调用，第&quot;</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;号任务close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="chatgpt-keyby分流再合流的用法" tabindex="-1"><a class="header-anchor" href="#chatgpt-keyby分流再合流的用法" aria-hidden="true">#</a> ChatGpt keyBy分流再合流的用法</h4><p>flink数据流中的数据，类型是json字符串，有两个字段，一个是type，一个是data，我想根据type的类型分别对数据流的data进行不同的处理，处理完之后再合流，应该怎么写?</p><p>参考：</p><div class="language-java ext-java"><pre class="language-java"><code>您可以使用<span class="token class-name">Flink</span>的keyBy和process函数来实现您的需求。首先，您需要使用keyBy函数将数据流分区为具有相同类型的记录。然后，您可以使用process函数来处理每个记录并将其发送到下一个算子以进行合并。以下是一个示例代码：

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> jsonDataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// your JSON data stream</span>

<span class="token comment">// keyBy type field</span>
<span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> jsonDataStream
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>jsonStr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// parse JSON string into Tuple2&lt;String, String&gt;</span>
        <span class="token class-name">JSONObject</span> jsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>tuple <span class="token operator">-&gt;</span> tuple<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// process data based on type</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> processedDataStream <span class="token operator">=</span> keyedStream
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tuple<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> type <span class="token operator">=</span> tuple<span class="token punctuation">.</span>f0<span class="token punctuation">;</span>
            <span class="token class-name">String</span> data <span class="token operator">=</span> tuple<span class="token punctuation">.</span>f1<span class="token punctuation">;</span>

            <span class="token comment">// process data based on type</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// process data for type1</span>
                <span class="token class-name">String</span> processedData <span class="token operator">=</span> <span class="token function">processDataForType1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>processedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// process data for type2</span>
                <span class="token class-name">String</span> processedData <span class="token operator">=</span> <span class="token function">processDataForType2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>processedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// unknown type</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown type: &quot;</span> <span class="token operator">+</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// define your own processDataForType1 and processDataForType2 functions</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">processDataForType1</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// process data for type1</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">processDataForType2</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// process data for type2</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
在上面的代码中，我们首先将JSON字符串转换为具有类型和数据字段的元组。然后，我们使用keyBy函数将数据流分区为具有相同类型的记录。最后，我们使用process函数来处理每个记录并将其发送到下一个算子以进行合并。在process函数中，我们根据类型字段处理数据，并将处理后的数据发送到下一个算子以进行合并。
</code></pre></div><p>flink数据流中的数据，类型是json字符串，有两个字段，一个是type，一个是data，我想根据type的类型分别对数据流的data进行不同的处理，这里的处理包括对data的某些字段按事件时间进行聚合操作，处理完之后再合流，应该怎么写?</p><div class="language-java ext-java"><pre class="language-java"><code>如果您需要根据JSON数据的type字段对数据流中的数据进行不同的处理，并按事件时间对数据进行聚合操作，您可以使用<span class="token class-name">Flink</span>的keyBy函数将数据流分区为具有相同类型的记录，并使用window函数和reduce函数对每个窗口中的数据进行聚合操作。接下来，您可以使用union函数将处理后的数据流合并为一个数据流。以下是一个示例代码：

<span class="token class-name">Copy</span>
<span class="token comment">// POJO class for JSON data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> jsonDataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// your JSON data stream</span>

<span class="token comment">// map JSON string to Data object</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> jsonDataStream
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>jsonStr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// parse JSON string into Data object</span>
        <span class="token class-name">JSONObject</span> jsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// keyBy type field</span>
<span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> dataStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// window and reduce</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> processedDataStream <span class="token operator">=</span> keyedStream
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Data</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Data</span> data1<span class="token punctuation">,</span> <span class="token class-name">Data</span> data2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">// parse JSON string into JSONObject</span>
            <span class="token class-name">JSONObject</span> jsonObj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>data1<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> jsonObj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>data2<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// aggregate fields based on event time</span>
            <span class="token keyword">double</span> field1 <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>jsonObj1<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jsonObj2<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> field2 <span class="token operator">=</span> jsonObj1<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> jsonObj2<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// add more fields as needed</span>
            <span class="token comment">// create new JSON object</span>
            <span class="token class-name">JSONObject</span> newJsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newJsonObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">,</span> field1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newJsonObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">,</span> field2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// add more fields as needed</span>
            <span class="token comment">// create new Data object</span>
            <span class="token class-name">Data</span> newData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span>data1<span class="token punctuation">.</span>type<span class="token punctuation">,</span> newJsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> newData<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// union processed data streams</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> unionedDataStream <span class="token operator">=</span> processedDataStream1
    <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>processedDataStream2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>processedDataStream3<span class="token punctuation">)</span>
    <span class="token comment">// add more data streams as needed</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">,</span> <span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Data</span> data<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
在上面的代码中，我们首先将JSON字符串转换为<span class="token class-name">Data</span>对象。然后，我们使用keyBy函数将数据流分区为具有相同类型的记录。接下来，我们使用window函数和reduce函数对每个窗口中的数据进行聚合操作。在reduce函数中，我们首先将JSON字符串转换为<span class="token class-name">JSONObject</span>，然后根据事件时间进行聚合操作，并创建新的JSON对象和<span class="token class-name">Data</span>对象。最后，我们使用union函数将处理后的数据流合并为一个数据流，并使用process函数将数据发送到下一个算子以进行处理。
</code></pre></div><p>上面的代码，不同type的data聚合时间不同，有些data需要1小时聚合一次，有些data需要4小时聚合一次，能否写详细一些</p><div class="language-java ext-java"><pre class="language-java"><code>如果不同type的data需要根据不同的时间窗口进行聚合操作，您可以使用<span class="token class-name">Flink</span>的assignTimestampsAndWatermarks函数为每个记录分配事件时间，并使用keyBy函数将数据流分区为具有相同类型的记录。接下来，您可以使用window函数和reduce函数对每个窗口中的数据进行聚合操作。在window函数中，您可以使用<span class="token class-name">EventTimeSessionWindows</span>或<span class="token class-name">EventTimeProcessingTimeWindows</span>等窗口类型，并根据数据的类型和事件时间选择不同的时间窗口长度。以下是示例代码：

<span class="token class-name">Copy</span>
<span class="token comment">// POJO class for JSON data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> jsonDataStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// your JSON data stream</span>

<span class="token comment">// map JSON string to Data object and assign event time</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> jsonDataStream
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>jsonStr <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// parse JSON string into Data object</span>
        <span class="token class-name">JSONObject</span> jsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> data <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// assign event time based on data type</span>
        <span class="token keyword">long</span> eventTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventTime <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eventTime <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 4 hours later</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// add more types as needed</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Data</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// extract event time from data</span>
            <span class="token class-name">JSONObject</span> jsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> eventTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventTime <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;type2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventTime <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 4 hours later</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// add more types as needed</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> eventTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// keyBy type field</span>
<span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> dataStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// window and reduce</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> processedDataStream <span class="token operator">=</span> keyedStream
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">EventTimeSessionWindows</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">hours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Data</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Data</span> data1<span class="token punctuation">,</span> <span class="token class-name">Data</span> data2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token comment">// parse JSON string into JSONObject</span>
            <span class="token class-name">JSONObject</span> jsonObj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>data1<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JSONObject</span> jsonObj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>data2<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// aggregate fields based on event time</span>
            <span class="token keyword">double</span> field1 <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>jsonObj1<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jsonObj2<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> field2 <span class="token operator">=</span> jsonObj1<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> jsonObj2<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// add more fields as needed</span>
            <span class="token comment">// create new JSON object</span>
            <span class="token class-name">JSONObject</span> newJsonObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newJsonObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;field1&quot;</span><span class="token punctuation">,</span> field1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newJsonObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;field2&quot;</span><span class="token punctuation">,</span> field2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// add more fields as needed</span>
            <span class="token comment">// create new Data object</span>
            <span class="token class-name">Data</span> newData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span>data1<span class="token punctuation">.</span>type<span class="token punctuation">,</span> newJsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> newData<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// union processed data streams</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> unionedDataStream <span class="token operator">=</span> processedDataStream1
    <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>processedDataStream2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>processedDataStream3<span class="token punctuation">)</span>
    <span class="token comment">// add more data streams as needed</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">,</span> <span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Data</span> data<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Data</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
在上面的代码中，我们为每个记录分配了事件时间，并使用keyBy函数将数据流分区为具有相同类型的记录。接下来，我们使用window函数和reduce函数对每个窗口中的数据进行聚合操作。在window函数中，我们使用<span class="token class-name">EventTimeSessionWindows</span>窗口类型，并根据数据的类型和事件时间选择不同的时间窗口长度。例如，对于type1
</code></pre></div><h3 id="物理分区" tabindex="-1"><a class="header-anchor" href="#物理分区" aria-hidden="true">#</a> 物理分区</h3><p>keyBy是逻辑分区，至于分得均不均匀，每个key的数据要到哪一区去，这些是完全无从控制的。</p><p>因为按key划分，可能分出很多key，远远超过slot数</p><p>物理分区可以控制分区策略，精准调配数据.</p><p>例如我们编写的程序，可能对多个处理任务或者说算子设置了不同的并行度，那么当数据执行的上下游任务并行度变化时，数据就不应该在当前分区以直通方式传输了，因为如果并行度变小，当前分区可能没有下游任务了；而如果并行度变大，所有数据还在原先的分区处理就会导致资源的浪费。所以这种情况下，系统会自动地将数据均匀地发往下游所有并行任务，保证各个分区负载均衡。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">// 随机分区</span>
stream<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 轮询分区</span>
stream<span class="token punctuation">.</span><span class="token function">rebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="输出算子" tabindex="-1"><a class="header-anchor" href="#输出算子" aria-hidden="true">#</a> 输出算子</h3><p>flink作为数据处理框架，最终还是要把计算处理的结果写入外部存储，为外部应用提供支持。</p><p>建立连接，释放连接，在继承自RichFunction的类里就可以实现这些。</p><p>但是一般不这样做。flink把向外部系统写入这步操作抽象提炼成了sink。</p><p>dataStream的print()方法，内部也是实现了addSink()</p><div class="language-java ext-java"><pre class="language-java"><code>    <span class="token annotation punctuation">@PublicEvolving</span>
    <span class="token keyword">public</span> <span class="token class-name">DataStreamSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PrintSinkFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> printFunction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintSinkFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>printFunction<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;Print to Std. Out&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>PrintSinkFunction继承自RichSinkFunction</p><p>SinkFunction多数情况下并不需要我们自己实现。</p><p>像kafka之类流式系统，flink提供了完美对接，source、sink两端都能连，可读可写，而对于es、文件系统、jdbc等数据存储系统，则只提供了输出写入的sinkFunction</p><h4 id="输出到文件" tabindex="-1"><a class="header-anchor" href="#输出到文件" aria-hidden="true">#</a> 输出到文件</h4><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkToFileTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StreamingFileSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fileSink <span class="token operator">=</span>
                <span class="token class-name">StreamingFileSink</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">forRowFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;./output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">//指定滚动策略</span>
                        <span class="token keyword">new</span> <span class="token class-name">SimpleStringEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withRollingPolicy</span><span class="token punctuation">(</span>
                                <span class="token class-name">DefaultRollingPolicy</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token comment">//指定文件大小，达到多少就归档保存</span>
                                        <span class="token punctuation">.</span><span class="token function">withMaxPartSize</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                                        <span class="token comment">//定义隔多长时间滚动一次，开启一个新的文件</span>
                                        <span class="token punctuation">.</span><span class="token function">withRolloverInterval</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token comment">// 指定多久没有数据到来，文件就归档保存</span>
                                        <span class="token punctuation">.</span><span class="token function">withInactivityInterval</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>fileSink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="输出到kafka" tabindex="-1"><a class="header-anchor" href="#输出到kafka" aria-hidden="true">#</a> 输出到kafka</h4><p>kafka是消息队列，处理的也是流式数据，和flink天生一对。</p><p>flink与kafka的连接器提供了端到端的精确一次的语义保证，这在实际项目中是最高级别的一致性保证。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SinkToKafkaTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//kafka配置</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xxxxx:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//从Kafka获取数据流</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token string">&quot;clicks&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 读到的是String，要转换成event</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fields<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 结果数据写入kafka</span>
        result<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token string">&quot;xxxxx:9092&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;events&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="第七章-时间和窗口" tabindex="-1"><a class="header-anchor" href="#第七章-时间和窗口" aria-hidden="true">#</a> 第七章 时间和窗口</h2><p>在流处理应用中，很重要很常见的操作就是窗口计算。</p><p>所谓的窗口一般就是划定的一段时间范围，对这范围内的数据进行处理，就是所谓的窗口计算。所以窗口和时间往往是分不开的。</p><h3 id="时间语义" tabindex="-1"><a class="header-anchor" href="#时间语义" aria-hidden="true">#</a> 时间语义</h3><p><img src="/study/assets/image-20230411104546144.8132c981.png" alt="image-20230411104546144"></p><p><strong>事件产生的时间，进入Flink的时间，以及被某个算子处理的时间完全是不一样的。</strong></p><p>事件发生之后，生成的数据被收集起来，首先进入分布式消息队列，然后被Flink系统的source算子读取消费，进而向下游的窗口算子传递，最后进行处理计算。</p><p>这里有两个非常重要的时间点，一个是数据产生的时间，一个是数据进入窗口真正被处理的时间，这两个时间不一样，我们定义的窗口操作到底以哪种时间作为衡量标准，就是所谓的时间语义。</p><p><strong>在计算机系统中，考虑数据处理的时间是没什么意义的，我们更关心的，显然是数据本身产生的时间。所以在实际应用中，事件时间语义会更常见，也就是事件产生时间而不是事件处理时间。一般情况下，业务日志数据处理中都会记录数据生成的时间戳，它就可以作为事件时间判断的基础。</strong></p><p>事件时间，也就是数据生成的时间，数据一旦产生，这个时间就确定了，所以它可以作为一个属性嵌入到数据中，这其实就是这条数据的时间戳。</p><p>在事件时间语义下，我们对于时间的衡量，<strong>就不看任何机器的系统时间了</strong>，而是依赖于数据本身。由于分布式系统中网络传输延迟的不确定性，实际应用中我们要面对的数据流往往是乱序的。在这种情况下，就不能简单地把数据自带的时间戳当作时钟了，而需要用另外的标志来表示事件时间进展，在Flink中把它叫做<strong>事件时间的水位线（watermarks）</strong>。</p><h3 id="水位线" tabindex="-1"><a class="header-anchor" href="#水位线" aria-hidden="true">#</a> 水位线</h3><p><img src="/study/assets/image-20230411111028715.01af8b54.png" alt="image-20230411111028715"></p><p><strong>在窗口的处理过程中，我们可以基于数据的时间戳，自定义一个逻辑时钟，这个时钟的时间不会自动流逝，它的时间进展，就是靠着新到数据的时间戳来推动的。</strong></p><p>这样的好处在于，计算的过程可以完全不依赖于处理时间（系统时间）。</p><p>在Flink中，用来衡量事件时间进展的标记，就被称作水位线。</p><p>水位线可以看作一条特殊的数据记录，它是<code>插入</code>到数据流中的一个标记点，主要内容就是一个<code>时间戳</code>，用来指示当前的事件时间。而它插入流中的位置，就是在某个数据到来之后。</p><p><img src="/study/assets/image-20230411112932546.11a521aa.png" alt="image-20230411112932546"></p><ol><li><p>有序流中的水位线</p><p><code>在理想状态下</code>，数据应该按照他们的先后顺序进入流中，这样的话我们从每个数据中提取时间戳，就可以保证总是从小到大增长的，从而插入的水位线也会不断增长，事件时钟不断向前推进。</p><p>实际应用中，如果当前数据量非常大，可能会有很多数据的时间戳是相同的，这时每来一条数据就提取时间戳，插入水位线就做了大量的无用功，而且即使时间戳不同，同时涌来的数据时间差会非常小，往往对处理计算也没什么影响。所以为了提高效率，一般每隔一段时间就会生成一个水位线，这个水位线的时间戳就是当前最新数据的时间戳，所以这时的水位线，其实就是有序流的一个周期性出现的时间标记。</p><p><img src="/study/assets/image-20230411113818749.15191bec.png" alt="image-20230411113818749"></p></li><li><p>乱序流中的水位线</p><p>在分布式系统中，数据在节点中传输，会因为网络传输延迟的不确定性，导致顺序发生改变，这就是所谓的乱序数据。</p><p>一个7秒时产生的数据，生成时间自然要比9秒的数据早，但是经过数据缓存和传输之后，处理任务可能先收到了9秒的数据，之后才是7秒的数据，这就是乱序。</p><p>解决思路：</p><p>还是靠数据来驱动，不依靠真正的系统时间，每来一个时间就提取它的时间戳，插入一个水位线。不过现在的情况是数据乱序，<strong>所以插入新的水位线时，要先判断一下时间戳是否比之前的大，否则就不再生成新的水位线。也就是说，只有数据的时间戳比当前时间戳大，才能推动时间推进，才插入水位线。</strong></p><p><img src="/study/assets/image-20230411115327839.8fb2dd08.png" alt="image-20230411115327839"></p></li></ol><p>水位线watermark(t)，表示在当前流中，事件时间已经达到了时间戳t，这代表t之前的所有数据都到齐了，之后流中不会出现小于时间戳t的数据。</p><p>设置水位线的方法</p><p><code>assignTimestampsAndWatermarks()</code>里面要传一个参数，就是watermark的生成策略。</p><p>水位线生产的<strong>最佳位置是在尽可能靠近数据源的地方</strong>，因为水位线生成时会做出一些有关元素顺序相对时间戳的假设。由于数据源读取过程是并行的，一切引起Flink跨行数据流分区进行重新分发的操作（比如：改变并行度，keyby等）都会导致元素时间戳乱序。但是如果是某些初始化的filter、map等不会引起元素重新分发的操作，所以是可以考虑在生成水位线之前使用。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WatermarkTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生成水位线的时间间隔</span>
        env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 有序流的watermark生成</span>
<span class="token comment">//                .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps()</span>
<span class="token comment">//                .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() {</span>
<span class="token comment">//                    @Override</span>
<span class="token comment">//                    public long extractTimestamp(Event event, long recordTimestamp) {</span>
<span class="token comment">//                        return event.timestamp;</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }));</span>
                <span class="token comment">//乱序流的watermark生成,要指定延迟时间，处理迟到数据</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> recordTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>水位线的生成，一定要有水位线的生成器和时间戳的提取器。</p><h3 id="窗口" tabindex="-1"><a class="header-anchor" href="#窗口" aria-hidden="true">#</a> 窗口</h3><h4 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h4><p>在大数据流式计算中，基于时间最常见的操作就是窗口，最典型的利用时间来控制输出的就是窗口。</p><p>我们很容易把窗口想象成一个固定位置的“框”，数据源源不断流过来，到某个时间点窗口该关闭了，就停止收集数据、触发计算并输出结果。</p><h4 id="分类" tabindex="-1"><a class="header-anchor" href="#分类" aria-hidden="true">#</a> 分类</h4><p>在flink中，窗口的应用非常灵活，我们可以使用各种不同类型的窗口来实现需求。</p><p>按照驱动类型分类</p><p>窗口本身是截取有界数据的一种方式，以什么标准来开始和结束数据的截取。</p><p>按照时间段去截取数据的窗口就叫做时间窗口，这在实际应用中最常见，除了由时间驱动之外，窗口其实也可以由数据驱动，也就是说按照固定的个数，来截取一段数据集，这叫计数窗口。</p><p>时间窗口</p><ul><li>滚动窗口</li><li>滑动窗口</li><li>会话窗口</li></ul><p>计数窗口</p><p>全局窗口</p><p>这种窗口全局有效，会把相同key的所有数据都分配到同一个窗口中，这种窗口没有结束的时候，默认是不会触发计算的，如果希望它能对数据进行计算处理，还需要自定义触发器trigger</p><h4 id="窗口api" tabindex="-1"><a class="header-anchor" href="#窗口api" aria-hidden="true">#</a> 窗口API</h4><ol><li><p>按键分区和非按键分区</p><p>在定义窗口操作之前，首先需要确定，是基于按键分区的数据流KeyedStream来开窗，还是直接在没有分区的DataStream上开窗，也就是说，在调用窗口算子之前，是否有keyBy操作。</p><p>按键分区窗口</p><p>经过按键分区keyBy操作后，数据流会按照key被分为多条逻辑流，这就是keyedStream，基于keyedStream进行窗口操作时，窗口计算会在多个并行子任务上同时执行。相同key的数据会被发送到同一个并行子任务。所以可以认为，每个key上都定义了一组窗口，各自独立地进行统计计算。</p><p>非按键分区窗口</p><p>如果没有进行keyBy，那么原始的DataStream就不会分成多条逻辑流，这时窗口逻辑只能在一个任务上执行，这就相当于并行度为1.所以在实际应用中一般不推荐使用这种方式。</p><p>这里需要注意的是，对于非按键分区的窗口操作，手动调大窗口算子的并行度也是无效的，windowAll本身就是一个非并行的操作。</p></li></ol><h4 id="窗口分配器" tabindex="-1"><a class="header-anchor" href="#窗口分配器" aria-hidden="true">#</a> 窗口分配器</h4><p>定义几种窗口的方法</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生成水位线的时间间隔</span>
        env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 有序流的watermark生成</span>
<span class="token comment">//                .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps()</span>
<span class="token comment">//                .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() {</span>
<span class="token comment">//                    @Override</span>
<span class="token comment">//                    public long extractTimestamp(Event event, long recordTimestamp) {</span>
<span class="token comment">//                        return event.timestamp;</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }));</span>
                <span class="token comment">//乱序流的watermark生成,要指定延迟时间，处理迟到数据</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> recordTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">countWindow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 计数窗口, 传1个参数就是滚动窗口，传2个参数就是滑动窗口</span>
<span class="token comment">//                .window(EventTimeSessionWindows.withGap(Time.seconds(2)));//事件时间会话窗口</span>
<span class="token comment">//                .window(SlidingEventTimeWindows.of(Time.hours(1), Time.minutes(5)));// 滑动时间窗口，1小时，步长5min</span>
<span class="token comment">//                .window(TumblingEventTimeWindows.of(Time.hours(1))); // 定义1小时的滚动时间窗口</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里还没完，还需要用窗口函数，对分配到窗口内的数据做处理。</p><h4 id="窗口函数" tabindex="-1"><a class="header-anchor" href="#窗口函数" aria-hidden="true">#</a> 窗口函数</h4><p>定义了窗口分配器，我们只是知道了数据属于哪个窗口，可以将数据收集起来了；至于收集起来到底要做什么，必须再接上一个定义窗口如何进行计算的操作，这就是窗口函数。</p><p><img src="/study/assets/image-20230412140212223.d41b1d3a.png" alt="image-20230412140212223"></p><ol><li><p>增量聚合函数</p><p>窗口将数据收集起来，最基本的处理操作就是进行聚合。我们可以每来一个数据就在之前结果上聚合一次，这就是增量聚合。</p><p>典型的增量聚合函数有两个：ReduceFunction和AggregateFunction</p><p>ReduceFunction：</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生成水位线的时间间隔</span>
        env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 有序流的watermark生成</span>
<span class="token comment">//                .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps()</span>
<span class="token comment">//                .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() {</span>
<span class="token comment">//                    @Override</span>
<span class="token comment">//                    public long extractTimestamp(Event event, long recordTimestamp) {</span>
<span class="token comment">//                        return event.timestamp;</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }));</span>
                <span class="token comment">//乱序流的watermark生成,要指定延迟时间，处理迟到数据</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> recordTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span>
<span class="token comment">//                .countWindow(10, 2);// 计数窗口, 传1个参数就是滚动窗口，传2个参数就是滑动窗口</span>
<span class="token comment">//                .window(EventTimeSessionWindows.withGap(Time.seconds(2)));//事件时间会话窗口</span>
<span class="token comment">//                .window(SlidingEventTimeWindows.of(Time.hours(1), Time.minutes(5)));// 滑动时间窗口，1小时，步长5min</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 定义1小时的滚动时间窗口</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> value1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AggregateFunction</p><p>AggregateFunction可以看作是ReduceFunction的通用版本，这里有三种类型：输入类型（IN），累加器类型（ACC）和输出类型（OUT）</p><p>接口中有四个方法：</p><ul><li>createAccumulator()</li><li>add()</li><li>getResult()</li><li>merge()</li></ul></li><li><p>全窗口函数</p><p>有些场景下，要做的计算必须基于全部的数据才有效，这时做增量聚合就没什么意义。</p></li></ol><h2 id="第八章-分流合流" tabindex="-1"><a class="header-anchor" href="#第八章-分流合流" aria-hidden="true">#</a> 第八章 分流合流</h2><h3 id="分流" tabindex="-1"><a class="header-anchor" href="#分流" aria-hidden="true">#</a> 分流</h3><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SplitStreamTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置生成水位线的时间间隔</span>
        env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoWatermarkInterval</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=100&quot;</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">3300L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">4000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=2&quot;</span><span class="token punctuation">,</span> <span class="token number">3500L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=3&quot;</span><span class="token punctuation">,</span> <span class="token number">3800L</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 有序流的watermark生成</span>
<span class="token comment">//                .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;Event&gt;forMonotonousTimestamps()</span>
<span class="token comment">//                .withTimestampAssigner(new SerializableTimestampAssigner&lt;Event&gt;() {</span>
<span class="token comment">//                    @Override</span>
<span class="token comment">//                    public long extractTimestamp(Event event, long recordTimestamp) {</span>
<span class="token comment">//                        return event.timestamp;</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }));</span>
                <span class="token comment">//乱序流的watermark生成,要指定延迟时间，处理迟到数据</span>
                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token function">forBoundedOutOfOrderness</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withTimestampAssigner</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SerializableTimestampAssigner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token keyword">long</span> recordTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 定义输出标签</span>
        <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> maryTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> bobTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> process <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">,</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span>Context ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>maryTag<span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> event<span class="token punctuation">.</span>url<span class="token punctuation">,</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>bobTag<span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> event<span class="token punctuation">.</span>url<span class="token punctuation">,</span> event<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 64005626+shaileneF@users.noreply.github.com">shailene</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/study/assets/app.4e5a7100.js" defer></script>
  </body>
</html>
