<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/icon/111.ico"><title>Flink基本篇 | shAilene</title><meta name="description" content="just be simple.">
    <link rel="modulepreload" href="/study/assets/app.041ef42b.js"><link rel="modulepreload" href="/study/assets/flink基本篇1.html.2da5e64b.js"><link rel="modulepreload" href="/study/assets/flink基本篇1.html.e205aef7.js"><link rel="prefetch" href="/study/assets/index.html.7efdd086.js"><link rel="prefetch" href="/study/assets/index.html.5b546ffc.js"><link rel="prefetch" href="/study/assets/index.html.5d5428a2.js"><link rel="prefetch" href="/study/assets/index.html.e0747d56.js"><link rel="prefetch" href="/study/assets/index.html.36ab45a8.js"><link rel="prefetch" href="/study/assets/gin.html.4cd5fffc.js"><link rel="prefetch" href="/study/assets/golang.html.a794921a.js"><link rel="prefetch" href="/study/assets/gorm.html.2f54e87a.js"><link rel="prefetch" href="/study/assets/Javaweb.html.99d0851e.js"><link rel="prefetch" href="/study/assets/ES.html.1b44db36.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.f1691262.js"><link rel="prefetch" href="/study/assets/Java笔记.html.0ce0a367.js"><link rel="prefetch" href="/study/assets/dubbo.html.a004256f.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.09d9d733.js"><link rel="prefetch" href="/study/assets/springcloud（下）.html.7f010e8c.js"><link rel="prefetch" href="/study/assets/zookeeper.html.0e69c298.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.bafc18ad.js"><link rel="prefetch" href="/study/assets/并发编程.html.4528ac44.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.6222a736.js"><link rel="prefetch" href="/study/assets/redis.html.7d752b3a.js"><link rel="prefetch" href="/study/assets/Mybatis.html.b64b7364.js"><link rel="prefetch" href="/study/assets/spring.html.fa389ccd.js"><link rel="prefetch" href="/study/assets/springboot.html.63b4d2a3.js"><link rel="prefetch" href="/study/assets/springboot.html.4a69da24.js"><link rel="prefetch" href="/study/assets/springMVC.html.22d6764d.js"><link rel="prefetch" href="/study/assets/kafka.html.16c16336.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.1769b532.js"><link rel="prefetch" href="/study/assets/操作系统.html.7ba9adfa.js"><link rel="prefetch" href="/study/assets/flink基本篇2.html.fc734dbf.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.0de21fc4.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.c91dbde5.js"><link rel="prefetch" href="/study/assets/404.html.93146c89.js"><link rel="prefetch" href="/study/assets/index.html.ef798547.js"><link rel="prefetch" href="/study/assets/index.html.f2cf36f3.js"><link rel="prefetch" href="/study/assets/index.html.3995ab4c.js"><link rel="prefetch" href="/study/assets/index.html.3d01121e.js"><link rel="prefetch" href="/study/assets/index.html.dc642881.js"><link rel="prefetch" href="/study/assets/gin.html.90198a17.js"><link rel="prefetch" href="/study/assets/golang.html.1060dc69.js"><link rel="prefetch" href="/study/assets/gorm.html.d45a117b.js"><link rel="prefetch" href="/study/assets/Javaweb.html.5012b490.js"><link rel="prefetch" href="/study/assets/ES.html.78355eeb.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.d4061fd7.js"><link rel="prefetch" href="/study/assets/Java笔记.html.44302eb9.js"><link rel="prefetch" href="/study/assets/dubbo.html.a4efbf97.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.c334d2ca.js"><link rel="prefetch" href="/study/assets/springcloud（下）.html.05c6e52a.js"><link rel="prefetch" href="/study/assets/zookeeper.html.4e068260.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.e254df92.js"><link rel="prefetch" href="/study/assets/并发编程.html.280a82ba.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.38816429.js"><link rel="prefetch" href="/study/assets/redis.html.9856d0da.js"><link rel="prefetch" href="/study/assets/Mybatis.html.501d03d6.js"><link rel="prefetch" href="/study/assets/spring.html.b570b734.js"><link rel="prefetch" href="/study/assets/springboot.html.b67b6ea4.js"><link rel="prefetch" href="/study/assets/springboot.html.ff66386b.js"><link rel="prefetch" href="/study/assets/springMVC.html.23dd1c39.js"><link rel="prefetch" href="/study/assets/kafka.html.7cbd3438.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.5020ca5b.js"><link rel="prefetch" href="/study/assets/操作系统.html.be975415.js"><link rel="prefetch" href="/study/assets/flink基本篇2.html.f36ff311.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.9567e1ba.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.0f8ef1b9.js"><link rel="prefetch" href="/study/assets/404.html.46631348.js"><link rel="prefetch" href="/study/assets/404.27183943.js"><link rel="prefetch" href="/study/assets/Layout.7e9c067f.js">
    <link rel="stylesheet" href="/study/assets/style.2bba04cf.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/study/" class=""><img class="logo" src="/study/images/leo.jpg" alt="shAilene"><span class="site-name can-hide">shAilene</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/study/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/study/java/" class="" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="router-link-active" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Flink基本篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#第一章-初识flink" class="router-link-active router-link-exact-active sidebar-item" aria-label="第一章 初识Flink"><!--[--><!--]--> 第一章 初识Flink <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#实时处理和离线处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="实时处理和离线处理"><!--[--><!--]--> 实时处理和离线处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink流处理简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="Flink流处理简介"><!--[--><!--]--> Flink流处理简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink的特点" class="router-link-active router-link-exact-active sidebar-item" aria-label="flink的特点"><!--[--><!--]--> flink的特点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink是什么" class="router-link-active router-link-exact-active sidebar-item" aria-label="Flink是什么"><!--[--><!--]--> Flink是什么 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#为什么要用flink" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要用Flink"><!--[--><!--]--> 为什么要用Flink <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#流处理的发展和演变" class="router-link-active router-link-exact-active sidebar-item" aria-label="流处理的发展和演变"><!--[--><!--]--> 流处理的发展和演变 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink的主要特点" class="router-link-active router-link-exact-active sidebar-item" aria-label="Flink的主要特点"><!--[--><!--]--> Flink的主要特点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#分层api" class="router-link-active router-link-exact-active sidebar-item" aria-label="分层API"><!--[--><!--]--> 分层API <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink与spark的一些区别" class="router-link-active router-link-exact-active sidebar-item" aria-label="Flink与Spark的一些区别"><!--[--><!--]--> Flink与Spark的一些区别 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#第二章-快速上手" class="router-link-active router-link-exact-active sidebar-item" aria-label="第二章 快速上手"><!--[--><!--]--> 第二章 快速上手 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#环境准备" class="router-link-active router-link-exact-active sidebar-item" aria-label="环境准备"><!--[--><!--]--> 环境准备 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#批处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="批处理"><!--[--><!--]--> 批处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#流处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="流处理"><!--[--><!--]--> 流处理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#窗口" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口"><!--[--><!--]--> 窗口 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="概念"><!--[--><!--]--> 概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#分类" class="router-link-active router-link-exact-active sidebar-item" aria-label="分类"><!--[--><!--]--> 分类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#窗口api" class="router-link-active router-link-exact-active sidebar-item" aria-label="窗口API"><!--[--><!--]--> 窗口API <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#api调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="API调用"><!--[--><!--]--> API调用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#transformations" class="router-link-active router-link-exact-active sidebar-item" aria-label="Transformations"><!--[--><!--]--> Transformations <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#datastream" class="router-link-active router-link-exact-active sidebar-item" aria-label="DataStream"><!--[--><!--]--> DataStream <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#第三章-flink工作流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="第三章 Flink工作流程"><!--[--><!--]--> 第三章 Flink工作流程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#执行环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行环境"><!--[--><!--]--> 执行环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#执行模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行模式"><!--[--><!--]--> 执行模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#source" class="router-link-active router-link-exact-active sidebar-item" aria-label="source"><!--[--><!--]--> source <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#transformations-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="Transformations"><!--[--><!--]--> Transformations <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#基本转换算子" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本转换算子"><!--[--><!--]--> 基本转换算子 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#聚合算子" class="router-link-active router-link-exact-active sidebar-item" aria-label="聚合算子"><!--[--><!--]--> 聚合算子 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#自定义函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定义函数"><!--[--><!--]--> 自定义函数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#sink" class="router-link-active router-link-exact-active sidebar-item" aria-label="sink"><!--[--><!--]--> sink <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#第四章-flink部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="第四章 Flink部署"><!--[--><!--]--> 第四章 Flink部署 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#介绍-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#单机部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="单机部署"><!--[--><!--]--> 单机部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#flink-conf-配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="flink-conf 配置"><!--[--><!--]--> flink-conf 配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#向集群提交作业" class="router-link-active router-link-exact-active sidebar-item" aria-label="向集群提交作业"><!--[--><!--]--> 向集群提交作业 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#web-ui" class="router-link-active router-link-exact-active sidebar-item" aria-label="web UI"><!--[--><!--]--> web UI <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#命令行" class="router-link-active router-link-exact-active sidebar-item" aria-label="命令行"><!--[--><!--]--> 命令行 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/mw/Flink/Flink%E5%9F%BA%E6%9C%AC%E7%AF%87/flink%E5%9F%BA%E6%9C%AC%E7%AF%871.html#部署模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="部署模式"><!--[--><!--]--> 部署模式 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="flink基本篇" tabindex="-1"><a class="header-anchor" href="#flink基本篇" aria-hidden="true">#</a> Flink基本篇</h1><h2 id="第一章-初识flink" tabindex="-1"><a class="header-anchor" href="#第一章-初识flink" aria-hidden="true">#</a> 第一章 初识Flink</h2><h3 id="实时处理和离线处理" tabindex="-1"><a class="header-anchor" href="#实时处理和离线处理" aria-hidden="true">#</a> 实时处理和离线处理</h3><table><thead><tr><th style="text-align:left;"><strong>处理方式</strong></th><th style="text-align:left;"><strong>离线计算</strong></th><th style="text-align:left;"><strong>流式计算</strong></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>数据加载方式</strong></td><td style="text-align:left;">预先加载</td><td style="text-align:left;">实时加载</td></tr><tr><td style="text-align:left;"><strong>数据计算范围</strong></td><td style="text-align:left;">批量历史数据</td><td style="text-align:left;">单条或几条一批的少量最近时效的数据</td></tr><tr><td style="text-align:left;"><strong>时效性</strong></td><td style="text-align:left;">数小时级别延迟</td><td style="text-align:left;">秒级甚至毫秒级延迟</td></tr><tr><td style="text-align:left;"><strong>计算复杂度</strong></td><td style="text-align:left;">复杂的计算逻辑</td><td style="text-align:left;">相对简单的计算逻辑，需在时效性和复杂度二者之中权衡</td></tr><tr><td style="text-align:left;"><strong>是否可重复计算</strong></td><td style="text-align:left;">可回倒数据至有效存储时间的任意时间点重复计算</td><td style="text-align:left;">由于流式数据保留有效期较短，可回到短期有效存储时间的任意时间点重复计算</td></tr><tr><td style="text-align:left;"><strong>修改计算规则成本</strong></td><td style="text-align:left;">相对较低</td><td style="text-align:left;">相对较高</td></tr></tbody></table><h3 id="flink流处理简介" tabindex="-1"><a class="header-anchor" href="#flink流处理简介" aria-hidden="true">#</a> Flink流处理简介</h3><p>在流式处理中，Flink经常会从Kafka读取流数据，这也是应用最为广泛的组合，Kafka源源不断的向Flink输送数据，Flink<strong>处理</strong>数据在输送给各种数据库</p><h4 id="flink的特点" tabindex="-1"><a class="header-anchor" href="#flink的特点" aria-hidden="true">#</a> flink的特点</h4><ul><li><p>低延迟</p></li><li><p>高吞吐</p></li><li><p>语义化窗口</p></li><li><p>高容错</p></li><li><p>易用的API</p></li></ul><h4 id="flink是什么" tabindex="-1"><a class="header-anchor" href="#flink是什么" aria-hidden="true">#</a> Flink是什么</h4><ol><li><p>Flink是一个大数据处理框架（处理引擎），Flink做的是流处理，Spark做的是批处理.</p></li><li><p>flink是一个框架和分布式处理引擎，用于对无界和有界数据流进行<strong>状态</strong>计算</p><p>有界可以按时间划分有界，也可以按数据量划分有界。</p><p>flink是数据处理框架的代表</p><p>突出一个快速和灵巧</p></li><li><p>内存级别的响应速度，可扩展性很好。</p></li><li><p>flink框架处理流程</p><p><img src="/study/assets/image-20221116103533370.1e0f48ca.png" alt="image-20221116103533370"></p><p>flink要做的就是从外部把数据读取进来，然后做各种类型的处理。</p><p><strong>这个处理的过程是实时的</strong>，每来一个新的数据，都可以进行处理，并可以把结果返回给应用作为一个响应，也可以将处理结果写入事件日志等。</p><p>所以简单来看，这就像一个管道一样，pipeline，有一个数据源，数据源进来之后进行实时的处理，只要不断有数据进来，这些数据都能得到实时的处理。</p><p>左边数据进，右边数据出，从不同的数据存储介质里面读取数据，那么也可以将处理之后的数据写入不同的存储介质。</p><p>这就是flink的一个大概应用过程。</p><p>flink在多种场景都可以使用，只要数据源是实时的，或者业务需要对数据进行实时处理！</p></li><li><p>flink的应用场景：</p><ul><li>电商： <ul><li>实时报表</li><li>实时推荐</li><li>订单状态跟踪</li><li>信息推送</li></ul></li><li>物联网： <ul><li>实时数据采集</li><li>实时告警</li></ul></li><li>银行和金融业 <ul><li>实时结算</li><li>风险检测</li></ul></li></ul><p>实时数据处理在国内的场景太多了。比较典型的，比如一单实时的交易订单，完成之后，这就是实时数据，必须得到实时的处理，有实时的响应返回给应用，紧跟着有对应的消息下发给用户。</p><p>比如物流配送，是要实时地追踪物流订单的状态的。</p><p>如果数据量小，那么<strong>几台服务器部署后端服务</strong>，就可以搞定，但是海量的数据，就需要用上flink这个分布式<strong>实时计算框架</strong>了。</p></li></ol><h4 id="为什么要用flink" tabindex="-1"><a class="header-anchor" href="#为什么要用flink" aria-hidden="true">#</a> 为什么要用Flink</h4><ol><li><p>flink是流处理</p><p>真实的业务场景下，更多的是需要流式的处理（需要数据被实时地处理），数据都是像流一样一条条的，这样的场景多，但是数据一批一批的这样的场景也有。</p><p>批处理尽管<strong>实时性不太好</strong>，但是从系统设计和实际经验来看都是比较方便和高效的方式。</p><p>所以实时性，低延迟是批处理不具备的。</p></li><li><p>目标</p><ul><li>低延迟</li><li>高吞吐：也就是很快地处理海量数据。处理的数据量既大，处理数据又实时。</li><li>结果的准确性和容错性（如果发生故障，那么要能够恢复到数据之前的状态）</li></ul></li><li><p>传统数据处理架构</p><ul><li><p>事务处理</p><p>所谓计算层就是指的后台服务，这就是传统的web后端服务的架构，接收请求，处理请求，和数据库进行交互，响应给前端。</p><p>存储层也不完全是传统关系型数据库，NoSQL也是，比如MongoDB，REDIS内存级别的键值对数据库，Nebula Graph图数据库，ES、Solr这种文档型数据 库，他们所扮演的角色是一样的，就是数据存储层。数据存储层具有最大的一个特点就是数据具有持久性，那么要和数据库进行交互，当请求多，请求量大的时候，会存在响应慢的问题，除了Redis，因为Redis是内存级别的，但是Redis的成本很高。</p><p><img src="/study/assets/image-20221116111705471.cc500364.png" alt="image-20221116111705471"></p></li><li><p>分析处理</p><p>数据量可以非常大，但是是离线的。</p></li></ul><p>而我们现在的目标是低延迟高吞吐，又快数据量又大，不要离线的。既然要快，那么就要借鉴事务处理的架构，来一个就处理一下，如果说用事务处理的架构，关系型数据库变成了一个瓶颈，扩展起来之后速度变慢造价又高，那么现在一个基本的想法就是，直接把远程持久化存储变成一个本地状态，存在内存里面。</p><p><img src="/study/assets/image-20221116112947247.33282067.png" alt="image-20221116112947247"></p><p>基于这种想法，就有了有状态的流处理这种概念。</p><p>仍然是传统的架构，请求来了之后，计算，和存储层交互，但是存储层不使用持久化关系型数据库，而是改成一个本地状态，存储在内存中。和内存中的数据交互比和磁盘交互显然要快很多。</p><p>状态存储在内存中会有数据安全问题，所以flink会定期的将本地状态（内存中的状态）存盘，存进持久化数据库中去。---check point</p></li></ol><h4 id="流处理的发展和演变" tabindex="-1"><a class="header-anchor" href="#流处理的发展和演变" aria-hidden="true">#</a> 流处理的发展和演变</h4><ol><li><p>流处理的演变</p><ul><li><p>lambda架构</p><p>用两套系统，同时保证低延迟和结果准确</p><p>批处理器需要攒一批数据再处理，这就不够快，但是这能够保证数据的正确性。</p><p><img src="/study/assets/image-20221116113707728.358592ec.png" alt="image-20221116113707728"></p></li><li><p>新一代流处理器-Flink</p><p>用一套系统把lambda架构的两套功能全都搞定。</p><p>同时做到了低延迟和高吞吐。</p><p>对于Flink而言，它能够做到每秒钟处理百万级别的数据。</p><p>Flink能够保证结果准确性，Flink有事件时间的概念，这个事件时间就可以处理数据乱序。具体放在后面再讲。</p></li></ul></li><li><p>架构简图</p><ul><li><p>事件驱动型应用</p><p><img src="/study/assets/image-20221116115014606.fb2fc5b0.png" alt="image-20221116115014606"></p><p>数据源比较常见的是消息队列，所以比较常见的一个架构就是Flink直接去连接消息队列。</p><p>flink和kafka的连接是很常见的一种架构。</p><p>本地的状态就取代了原先的关系型数据库。</p></li><li><p>数据分析型应用</p><p><img src="/study/assets/image-20221116115412980.282b7519.png" alt="image-20221116115412980"></p><p>这就是一个实时的分析了。</p></li></ul></li></ol><h4 id="flink的主要特点" tabindex="-1"><a class="header-anchor" href="#flink的主要特点" aria-hidden="true">#</a> Flink的主要特点</h4><ul><li>高吞吐</li><li>低延迟</li><li>结果准确性</li><li>精确一次的状态一致性保证---如果发生故障，恢复到故障之前的状态，是完全一致的，就像没有发生故障一样</li><li>可以与众多常用存储系统连接</li><li>高可用，支持动态扩展</li></ul><h4 id="分层api" tabindex="-1"><a class="header-anchor" href="#分层api" aria-hidden="true">#</a> 分层API</h4><ol><li><p>整体来讲，Flink API分了四层</p><p>越顶层越抽象，表达含义越简明，使用越方便。</p><p>越底层越具体，表达能力越丰富，使用越灵活。</p><ul><li><p>SQL--最高层语言</p></li><li><p>Table API--声明式领域专用语言</p></li><li><p>DataStream/DataSet--核心API</p><p>在1.12版本之后，实现了统一，用DataStream API能做流处理和批处理。</p></li><li><p>有状态流处理--底层API</p></li></ul></li></ol><h3 id="flink与spark的一些区别" tabindex="-1"><a class="header-anchor" href="#flink与spark的一些区别" aria-hidden="true">#</a> Flink与Spark的一些区别</h3><p>数据处理架构</p><ol><li><p>flink认为批数据是特殊的流，是有界的数据流，这个边界在flink中叫做窗口。</p><p>spark认为把批数据切得足够小，就是流了。</p></li></ol><p>数据处理模型</p><ol><li>flink基本数据模型是数据流，以及事件（Event）序列。</li><li>spark采用的是RDD（弹性分布式数据集）模型，spark streaming的DStream实际上也是一组组小批数据RDD的集合。</li></ol><p>运行时架构</p><ol><li>spark是批计算，将DAG划分为<strong>不同的stage</strong>，一个完成后才可以做下一个。</li><li>flink是标准的流执行模式，一个事件（数据）在一个节点处理完后可以直接发往下一个节点进行处理，不用等其他事件或数据，就只跟当前数据和处理有关。</li></ol><h2 id="第二章-快速上手" tabindex="-1"><a class="header-anchor" href="#第二章-快速上手" aria-hidden="true">#</a> 第二章 快速上手</h2><h3 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h3><ol><li><p>Flink底层是用Java编写的，并为开发人员提供了完整的Java和Scala API。</p></li><li><p>创建Maven项目</p></li><li><p>引入依赖</p><ul><li><p>properties</p><div class="language-xml ext-xml"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flink.version</span><span class="token punctuation">&gt;</span></span>1.13.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flink.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slf4j.version</span><span class="token punctuation">&gt;</span></span>1.7.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slf4j.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>flink相关依赖</p><div class="language-xml ext-xml"><pre class="language-xml"><code>    <span class="token comment">&lt;!--flink相关依赖 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-java_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-clients_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>日志管理依赖</p><div class="language-xml ext-xml"><pre class="language-xml"><code>    <span class="token comment">&lt;!--日志依赖 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${slf4j.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${slf4j.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-to-slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.14.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul><p>在properties中，定义了scala.binary.version，这指代的是所依赖的Scala版本。这有一点奇怪：Flink底层是Java，而且我们也只用JavaAPI，为什么还会依赖Scala呢？这是因为Flink的架构中使用了Akka来实现底层的分布式通信，而Akka是用Scala开发的。</p></li></ol><h3 id="批处理" tabindex="-1"><a class="header-anchor" href="#批处理" aria-hidden="true">#</a> 批处理</h3><ol><li><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchWordCount</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1. 创建执行环境，flink的执行，是需要有一个复杂的集群，配合起来去做工作的，所以首先要创建执行环境</span>
        <span class="token class-name">ExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 从文件中读取数据，得到了数据源</span>
        <span class="token class-name">DataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataSource <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">&quot;input/words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 将每行数据进行分词，转换成二元组类型,map是一个通用的转换方法</span>
        <span class="token class-name">FlatMapOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wordTuple <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 收集器Collector也需要泛型，转换输出需要得到的类型是什么，Collector的泛型就写什么类型</span>
            <span class="token comment">// 在这里我们需要得到二元组，即每个单词的频次，那么这个泛型这里就需要写二元组</span>
            <span class="token comment">// 对于Scala来说，本身有元组类型，但是java没有，但是Flink定义了元组类型</span>

            <span class="token comment">// 1.将一行文本进行拆分</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 将每个单词转换成二元组输出</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>LONG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4. 按照word进行分组,传入的是Tuple的索引位置,给0表示以索引为0的位置的元素即word来作为分组的key</span>
        <span class="token class-name">UnsortedGrouping</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> group <span class="token operator">=</span> wordTuple<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5. 分组之后最终是要做统计的</span>
        <span class="token comment">// 分组内进行聚合，叠加</span>
        <span class="token comment">// 指定索引为1的位置的元素做求和的操作</span>
        <span class="token class-name">AggregateOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sum <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sum<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所有的转换操作都是基于DataSet在转换，我们把以上这些调用的API叫做DataSet API，也就是Flink的核心API。</p><p>但是从1.12开始，统一使用DataStream API就可以同时实现批处理和流处理。</p></li></ol><h3 id="流处理" tabindex="-1"><a class="header-anchor" href="#流处理" aria-hidden="true">#</a> 流处理</h3><h4 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h4><ol><li><p>用DataSet API可以很容易地实现批处理，与之对应，流处理当然可以用DataStream API来实现，对于Flink而言，流才是整个底层的核心逻辑，所以流批统一之后的DataStream API更加强大，可以直接处理批处理和流处理的所有场景。</p></li><li><p>在Flink的视角中，一切数据都可以认为是流，一切数据处理都可以认为是流处理。流数据是无界流，而<strong>批数据是有界流</strong>。</p></li><li><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BoundedStreamWordCount</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//1. 创建流处理的执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 读取文件，得到的source，继承自DataStream，所以以下用到的这一套API，叫做DataStream API</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">&quot;input/words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 转换计算</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> wordTuple <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.将一行文本进行拆分</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 将每个单词转换成二元组输出</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>LONG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//4. 按照word进行分组,传入的是Tuple的索引位置,给0表示以索引为0的位置的元素即word来作为分组的key</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tuple2StringKeyedStream <span class="token operator">=</span> wordTuple<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>data <span class="token operator">-&gt;</span> data<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5. 分组之后最终是要做统计的</span>
        <span class="token comment">// 分组内进行聚合，叠加</span>
        <span class="token comment">// 指定索引为1的位置的元素做求和的操作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sum <span class="token operator">=</span> tuple2StringKeyedStream<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.打印</span>
        <span class="token comment">// 执行以下这一步是打印不出结果的，是因为这是流处理模式，我们只是当前读取了一个有边界的文件，但是实际上工作模式是流处理，会认为数据是无界的，源源不断会到来的</span>
        sum<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//7. 启动执行，每来一次数据去执行一次整个的流程，所以会有最后一步执行。</span>
        <span class="token comment">// 把有边界的数据也当作流数据，所以这个地方还没有结束，因为流处理模式认为数据会源源不断到来</span>
        <span class="token comment">// 如果真正流数据来了之后，这个地方还没完呢，还要继续等待数据</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果</p><div class="language-text ext-text"><pre class="language-text"><code>7&gt; (flink,1)
5&gt; (world,1)
3&gt; (hello,1)
3&gt; (hello,2) #在之前hello 1的基础上，直接叠加，变成了2
3&gt; (hello,3)
2&gt; (java,1)
</code></pre></div><p><strong>前面的这个数字就代表了当前是哪个子任务，子任务是按并行度划分的。</strong></p><p>flink是分布式流处理引擎，如果在本地启动，会在本地启动多线程模拟分布式环境</p><p>flink管最小的资源单位叫任务槽。</p><p>并行度就是指当前这个任务通过多线程并行执行，多线程的个数。如果没有设置并行度，那么默认就是当前机器的CPU核心数量。</p></li><li><p>从socket，也就是通过网络传输读取文本流，后面的处理就是一样的，这里就是数据源不一样。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamWordCount</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建流式执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 读取一个socket文本流，通过socket发送数据</span>
        env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>从参数中提取主机名和端口号</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamWordCount</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建流式执行环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从参数中提取主机名和端口号</span>
        <span class="token class-name">ParameterTool</span> parameterTool <span class="token operator">=</span> <span class="token class-name">ParameterTool</span><span class="token punctuation">.</span><span class="token function">fromArgs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> hostname <span class="token operator">=</span> parameterTool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> parameterTool<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 读取一个socket文本流，通过socket发送数据</span>
        env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个parameterTool在哪里去获取参数？</p><p><img src="/study/assets/image-20221121163121757.420e1341.png" alt="image-20221121163121757"></p></li></ol><h3 id="窗口" tabindex="-1"><a class="header-anchor" href="#窗口" aria-hidden="true">#</a> 窗口</h3><h4 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h4><p>窗口是将无限数据切割成有限的”数据块“进行处理，窗口是处理无界流的核心。</p><p><img src="/study/assets/image-20230215160043431.f2d635c9.png" alt="image-20230215160043431"></p><p>窗口更像一个桶，将流切割成有限大小的多个存储桶，每个数据都会<code>分发</code>到对应的桶中，当到达窗口结束时间时，就对每个桶中收集的数据进行计算处理。</p><h4 id="分类" tabindex="-1"><a class="header-anchor" href="#分类" aria-hidden="true">#</a> 分类</h4><p>按照驱动类型来分类</p><p>以什么标准来开始和结束数据的截取，我们把它叫做窗口的”驱动类型“，常见的有时间窗口和计数窗口。</p><ul><li><p>时间窗口</p><p>时间窗口以时间点到来定义窗口的开始（start）和结束（end），所以截取出的就是某一时间段的数据。到达时间时，窗口不再收集数据，触发计算输出结果，并将窗口关闭销毁。</p><p>Flink中有一个专门的TimeWindow类来表示时间窗口，这个类只有两个私有属性，表示窗口的开始和结束的时间戳，单位为毫秒</p><p>窗口时间范围是左闭右开的区间。</p></li><li><p>计数窗口</p><p>基于元素的个数来截取数据，到达固定的个数时就触发计算并关闭窗口。</p></li></ul><p>在具体应用时，还需要定义更加精细的规则，来控制数据应该划分到哪个窗口中去。不同的分配数据的方式，就可以由不同的功能应用。</p><p>按照窗口分配数据的规则分类</p><ul><li><p>滚动窗口</p><p>滚动窗口有固定的大小，首尾相接，无缝衔接，每个数据都会被分配到一个窗口，而且只会属于一个窗口。</p></li><li><p>滑动窗口</p><p>滑动窗口的大小固定，但窗口之间不是首尾相接，而有部分重合。</p><p>定义滑动窗口的参数与两个：窗口大小，滑动步长。滑动步长是固定的，且代表了两个个窗口开始/结束的时间间隔。</p></li><li><p>会话窗口</p><p>会话窗口只能基于时间来定义，“会话”终止的标志就是隔一段时间没有数据来。</p><p>size：两个会话窗口之间的最小距离。我们可以设置静态固定的size，也可以通过一个自定义的提取器（gap extractor）动态提取最小间隔gap的值。</p><p>在Flink底层，对会话窗口有比较特殊的处理：每来一个新的数据，都会创建一个新的会话窗口，然后判断已有窗口之间的距离，<code>如果小于给定的size，就对它们进行合并操作</code>。在Winodw算子中，对会话窗口有单独的处理逻辑。</p><p>会话窗口的长度不固定、起始和结束时间不确定，各个分区窗口之间没有任何关联。会话窗口之间一定是不会重叠的，且会留有至少为size的间隔</p></li><li><p>全局窗口</p><p>相同key的所有数据都分配到一个同一个窗口中；无界流的数据永无止境，窗口没有结束的时候，默认不做触发计算，如果希望对数据进行计算处理，还需要自定义“触发器”（Trigger）</p></li></ul><h4 id="窗口api" tabindex="-1"><a class="header-anchor" href="#窗口api" aria-hidden="true">#</a> 窗口API</h4><p>Keyed</p><p>经过按按键分区keyBy操作后，数据流会按照key被分为多条逻辑流（logical streams），也就是KeyedStream。基于KeyedStream进行窗口操作时，窗口计算会在多个并行子任务上同时执行。相同key的数据被发送到同一个并行子任务，<strong>而窗口操作会基于每个key单独的处理</strong>。可以认为<strong>每个key上都定义了一组窗口</strong>，各自独立地进行统计计算。</p><div class="language-java ext-java"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>Non-keyed</p><p>如果没有进行keyBy，那么原始的DataStream就不会分成多条逻辑流。这时窗口逻辑只能在一个任务(task)上执行，相当于并行度变成了1</p><div class="language-java ext-java"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">windowAll</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="api调用" tabindex="-1"><a class="header-anchor" href="#api调用" aria-hidden="true">#</a> API调用</h4><p>窗口的操作主要有两个部分：窗口分配器（Window Assigners）和窗口函数（Window Functions）</p><div class="language-java ext-java"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>key selector<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
	 <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>window assigner<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
 	<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>window function<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
</code></pre></div><p>窗口分配器</p><p>定义窗口分配器是构建窗口算子的第一步，作用是定义数据应该被分配到哪个窗口</p><p>除去自定义外的全局窗口外，其它常用的类型Flink都给出了内置的分配器实现</p><p>时间窗口又可细分为滑动、滚动和会话三种。</p><p>计数窗口可分为滑动和滚动两种。</p><p>时间窗口</p><ul><li><p>滚动处理</p><div class="language-java ext-java"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>.of()还有一个重载方法，可以传入两个Time类型的参数：size和offset。第二个参数代表窗口起始点的偏移量，比如，标志时间戳是1970年1月1日0时0分0秒0毫秒开始计算的一个毫秒数，这个时间时UTC时间，以0时区为标准，而我们所在的时区为东八区（UTC+8）。我们定义一天滚动窗口时，伦敦时间0但对应北京时间早上8点。那么设定如下就可以得到北京时间每天0点开开启滚动窗口</p></li><li><p>滑动处理</p><div class="language-java ext-java"><pre class="language-java"><code>stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingProcessingTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>两个Time类型的参数：size和slide。后者表示滑动窗口的滑动步长。</p></li><li><p>会话处理</p></li></ul><p>定义窗口分配，知道数据属于哪个窗口；定义窗口函数，如何进行计算的操作。</p><h3 id="transformations" tabindex="-1"><a class="header-anchor" href="#transformations" aria-hidden="true">#</a> Transformations</h3><p>Flink 的 Transformations 操作主要用于将一个和多个 DataStream 按需转换成新的 DataStream。</p><h4 id="datastream" tabindex="-1"><a class="header-anchor" href="#datastream" aria-hidden="true">#</a> DataStream</h4><ol><li><p>Map</p><p>对一个DataStream中的每个元素都执行特定的转换操作</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> integerDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
integerDataStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> value <span class="token operator">-&gt;</span> value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出 2,4,6,8,10</span>
</code></pre></div></li><li><p>FlatMap</p><p>与Map类似，但是FlatMap中的一个输入元素可以被映射成一个或多个输出元素</p></li><li><p>Filter</p><p>用于过滤符合条件的数据</p></li><li><p>KeyBy</p><p>用于将相同key值的数据分到相同的分区中</p></li></ol><p>每一次操作（map、flatmap）等都是在新建一个Transformation并将当前Transformation与下一个建立链接的关系。</p><h2 id="第三章-flink工作流程" tabindex="-1"><a class="header-anchor" href="#第三章-flink工作流程" aria-hidden="true">#</a> 第三章 Flink工作流程</h2><h3 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h3><p>DataStream（数据流）本身是Flink中一个表示数据集合的类，我们编写的flink代码其实就是基于这种数据类型的处理，可以理解为这就是一套API，对于批处理和流处理，都可以用这同一套API来实现。</p><p>我们在代码中并不关心DataStream中具体的数据，而只是用API定义出的一连串操作来处理他们，这就叫做数据流的转换（transformations）。</p><p><strong>一个Flink程序，其实就是对DataStream的各种转换</strong></p><blockquote><p>具体来说，代码基本上都由以下几部分组成：</p><ul><li>获取执行环境</li><li>读取数据源</li><li>定义数据的转换操作、数据处理、数据清晰、数据聚合等（transformations）</li><li>定义计算结果的输出位置（sink）</li><li>触发执行程序</li></ul></blockquote><h3 id="执行环境" tabindex="-1"><a class="header-anchor" href="#执行环境" aria-hidden="true">#</a> 执行环境</h3><p><strong>Flink程序可以在各种上下文环境中运行，我们可以在本地JVM中执行程序，也可以提交到远程集群执行</strong></p><p>这就要求我们在提交作业执行计算时， 首先必须获取当前 Flink 的运行环境，从而建立起与 Flink 框架之间的联系。只有获取了环境上下文信息，才能将具体的任务调度到不同的 TaskManager 执行。</p><p>创建执行环境</p><p>最简单的方式，就是直接调用 getExecutionEnvironment方法。它会根据当前运行的上下文直接得到正确的结果：如果程序是独立运行的，就返回一个本地执行环境；如果是创建了 jar 包，然后从命令行调用它并提交到集群执行，那么就返回集群的执行环境。也就是说，这个方法会根据当前运行的方式，自行决定该返回什么样的运行环境。</p><h3 id="执行模式" tabindex="-1"><a class="header-anchor" href="#执行模式" aria-hidden="true">#</a> 执行模式</h3><p>从1.12.0版本起，Flink实现了API上的流批统一，Datastream API可以支持不同的执行模式</p><ul><li><p>流执行模式</p><p>一般用于需要持续实时处理的无界数据流，默认情况下，程序使用的就是流执行模式</p></li><li><p>批执行模式</p><p>对于不会持续计算的有界数据，我们用这种模式处理会更方便。</p></li><li><p>自动模式</p><p>在这种模式下，将由程序根据输入数据源是否有界，来自动选择执行模式。</p></li></ul><p>通过代码配置batch模式</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>什么时候用batch模式？</p><p>我们知道，Flink 本身持有的就是流处理的世界观，即使是批量数据，也可以看作“有界流”来进行处理。所以STREAMING 执行模式对于有界数据和无界数据都是有效的；而 BATCH 模式仅能用于有界数据。</p><p>看起来 BATCH 模式似乎被 STREAMING 模式全覆盖了，那还有必要存在吗？我们能不能所有情况下都用流处理模式呢？</p><p>当然是可以的，但是这样有时不够高效。</p><p>我们可以仔细回忆一下word count 程序中，批处理和流处理输出的不同：在 STREAMING 模式下，每来一条数据，就会输出一次结果（即使输入数据是有界的）；而 BATCH 模式下，只有数据全部处理完之后，才会一次性输出结果。最终的结果两者是一致的，但是流处理模式会将更多的中间结果输出。在本来输入有界、只希望通过批处理得到最终的结果的场景下， STREAMING 模式的逐个输出结果就没有必要了。</p><p>所以总结起来，一个简单的原则就是：用 BATCH 模式处理批量数据，用 STREAMING 模式处理流式数据。因为数据有界的时候，直接输出结果会更加高效；而当数据无界的时候, 我们没得选择——只有 STREAMING 模式才能处理持续的数据流。</p><p>有了执行环境，我们就可以构建程序的处理流程了：基于环境（env）读取数据源（source），从而得到数据流，对数据流（stream）进行各种转换操作（transformations），最后输出结果到外部系统（sink）。</p><h3 id="source" tabindex="-1"><a class="header-anchor" href="#source" aria-hidden="true">#</a> source</h3><div class="language-mermaid ext-mermaid"><pre class="language-mermaid"><code><span class="token keyword">graph</span> LR
env <span class="token arrow operator">--&gt;</span> source <span class="token arrow operator">--&gt;</span> transform <span class="token arrow operator">--&gt;</span> sink <span class="token arrow operator">--&gt;</span> env.execute
</code></pre></div><p>source就是我们整个处理程序的输入端。</p><p>Flink 代码中通用的添加 source 的方式，是调用执行环境的 <code>addSource()</code>方法：</p><p><code>DataStream&lt;String&gt; stream = env.addSource(...);</code></p><p>方法传入一个对象参数，需要实现SourceFunction 接口；返回DataStreamSource。这里的DataStreamSource类继承自SingleOutputStreamOperator类，又进一步继承自DataStream。所以很明显，读取数据的 source 操作是一个算子，得到的是一个数据流（DataStream）。</p><p><code>从kafka读取数据（重点）</code></p><p>在如今的实时流处理应用中，由 Kafka 进行数据的收集和传输，Flink 进行分析计算，这样的架构已经成为众多企业的首选。</p><div class="language-java ext-java"><pre class="language-java"><code>        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//kafka配置</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getBrokers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getKeyDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getValueDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span> kafkaConfig<span class="token punctuation">.</span><span class="token function">getAutoOffsetReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//从Kafka获取数据流</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                <span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        stream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre></div><h3 id="transformations-1" tabindex="-1"><a class="header-anchor" href="#transformations-1" aria-hidden="true">#</a> Transformations</h3><p>从数据源读入数据之后，我们就可以使用各种转换算子，将一个或多个DataStream转换为新的DataStream，一个Flink程序的核心，其实就是所有的转换操作，他们决定了处理的业务逻辑</p><h4 id="基本转换算子" tabindex="-1"><a class="header-anchor" href="#基本转换算子" aria-hidden="true">#</a> 基本转换算子</h4><ol><li><p>映射（map）</p><p>map主要用于将数据流中的数据进行转换，形成新的数据流，一个一个映射，消费一个元素就产出一个元素。</p><p>我们只需要基于DataStrema 调用 <code>map()</code>方法就可以进行转换处理。方法需要传入的参数是接口 MapFunction 的实现；返回值类型还是DataStream，不过泛型（流中的元素类型）可能改变。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransMapTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 传入匿名类，实现MapFunction</span>
        stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 传入MapFunction的实现类</span>
        stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserExtractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UserExtractor</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> e<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>MapFunction 实现类的泛型类型，与输入数据类型和输出数据的类型有关。</p><p>在实现 <code>MapFunction</code>接口的时候，需要指定两个泛型，分别是输入事件和输出事件的类型，还需要重写一个<code>map()</code>方法，定义从一个输入事件转换为另一个输出事件的具体逻辑。</p><p>Flink消费kafka，数据是json格式的数据</p><p>先反序列化，再通过对象清洗数据</p><div class="language-java ext-java"><pre class="language-java"><code>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">StreamRecord</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>string <span class="token operator">-&gt;</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> <span class="token class-name">Entity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//融合一些transformation算子进来</span>
        <span class="token comment">//map:输入一个元素，输出一个元素，可以用来做一些清洗工作</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">StreamRecord</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entity</span><span class="token punctuation">,</span> <span class="token class-name">Entity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Entity</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Entity</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">Entity</span> entity1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                entity1<span class="token punctuation">.</span>city <span class="token operator">=</span> value<span class="token punctuation">.</span>city<span class="token operator">+</span><span class="token string">&quot;.XPU.Xiax&quot;</span><span class="token punctuation">;</span>
                entity1<span class="token punctuation">.</span>phoneName <span class="token operator">=</span> value<span class="token punctuation">.</span>phoneName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                entity1<span class="token punctuation">.</span>loginTime <span class="token operator">=</span> value<span class="token punctuation">.</span>loginTime<span class="token punctuation">;</span>
                entity1<span class="token punctuation">.</span>os <span class="token operator">=</span> value<span class="token punctuation">.</span>os<span class="token punctuation">;</span>
                <span class="token keyword">return</span> entity1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li><li><p>过滤（filter）</p><p><code>filter</code> 转换操作，顾名思义是对数据流执行一个过滤，通过一个布尔条件表达式设置过滤条件，对于每一个流内元素进行判断，若为 true 则元素正常输出，若为 false 则元素被过滤掉。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">// 传入匿名类实现FilterFunction</span>
        stream<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li><li><p>扁平映射（flatMap）</p><p>主要是将数据流中的整体（一般是集合类型），拆分成一个一个的个体使用，消费一个元素，可以产生0到多个元素。</p><p>同 map 一样，flatMap 也可以使用Lambda 表达式或者 FlatMapFunction 接口实现类的方式来进行传参，返回值类型取决于所传参数的具体逻辑，可以与原数据流相同，也可以不同。</p><p>flatMap 操作会应用在每一个输入事件上面，FlatMapFunction 接口中定义了flatMap 方法， 用户可以重写这个方法，在这个方法中对输入数据进行处理，并决定是返回 0 个、1 个或多个结果数据。因此 flatMap 并没有直接定义返回值类型，而是通过一个“收集器”（Collector）来指定输出。希望输出结果时，只要调用收集器的.collect()方法就可以了；这个方法可以多次调用，也可以不调用。所以 flatMap 方法也可以实现 map 方法和 filter 方法的功能，当返回结果是 0 个的时候，就相当于对数据进行了过滤，当返回结果是 1 个的时候，相当于对数据进行了简单的转换操作。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">FlatMapFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransFlatmapTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyFlatMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyFlatMap</span> <span class="token keyword">implements</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Event</span> value<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="聚合算子" tabindex="-1"><a class="header-anchor" href="#聚合算子" aria-hidden="true">#</a> 聚合算子</h4><ol><li><p>按键分区--keyBy</p><p>在 Flink 中，要做聚合，需要<strong>先进行分区</strong>； 这个操作就是通过<code>keyBy</code>来完成的。</p><p>**keyBy 是聚合前必须要用到的一个算子。**keyBy 通过指定键（key），可以将一条流从逻辑上划分成不同的分区（partitions）。这里所说的分区，其实就是并行处理的子任务，也就对应着任务槽。</p><p>基于不同的key，流中的数据将被分配到不同的分区中去；<strong>这样一来，所有具有相同的key 的数据，都将被发往同一个分区，那么下一步算子操作就将会在同一个 slot 中进行处理了。</strong></p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeySelector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">KeyedStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransKeyByTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 Lambda 表达式</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用匿名类实现 KeySelector</span>
        <span class="token class-name">KeyedStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyedStream1 <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>泛型有两个类型：除去当前流中的元素类型外，还需要指定 key 的类型。</strong></p><p>keyBy会得到keyedStream，KeyedStream 是一个非常重要的数据结构，只有基于它才可以做后续的聚合操作（比如 sum，reduce）</p></li><li><p>聚合</p><p>有了按键分区的数据流 KeyedStream，我们就可以基于它进行聚合操作了。Flink 为我们内置实现了一些最基本、最简单的聚合API，主要有以下几种：</p><ul><li><p>sum()：在输入流上，对指定的字段做叠加求和的操作。</p></li><li><p>min()：在输入流上，对指定的字段求最小值。</p></li><li><p>max()：在输入流上，对指定的字段求最大值。</p></li><li><p>minBy()：与 min()类似，在输入流上针对指定字段求最小值。不同的是，min()只计算指定字段的最小值，其他字段会保留最初第一个数据的值；而minBy()则会返回包含字段最小值的整条数据。</p></li><li><p>maxBy() ：与 max() 类似， 在输入流上针对指定字段求最大值。两者区别与min()/minBy()完全一致。</p><p>简单聚合算子返回的，同样是一个 SingleOutputStreamOperator，也就是从 KeyedStream 又转换成了常规的 DataStream。所以可以这样理解：keyBy 和聚合是成对出现的，先分区、后聚合，得到的依然是一个 DataStream。而且经过简单聚合之后的数据流，元素的数据类型保持不变。</p><p><strong>一个聚合算子，会为每一个key 保存一个聚合的值，在Flink 中我们把它叫作“状态”（state）。所以每当有一个新的数据输入，算子就会更新保存的聚合结果，并发送一个带有更新后聚合值的事件到下游算子。对于无界流来说，这些状态是永远不会被清除的，所以我们使用聚合算子， 应该只用在含有有限个key的数据流上。</strong></p></li></ul></li><li><p>归约聚合</p><p>调用 KeyedStream 的 reduce 方法时，需要传入一个参数，实现 ReduceFunction 接口。</p><p>ReduceFunction 接口里需要实现 reduce()方法，这个方法接收两个输入事件，经过转换处理之后输出一个相同类型的事件；所以，对于一组数据，我们可以先取两个进行合并，然后再将合并的结果看作一个数据、再跟后面的数据合并，最终会将它“简化”成唯一的一个数据， 这也就是 reduce“归约”的含义。在流处理的底层实现过程中，实际上是将中间“合并的结果” 作为任务的一个状态保存起来的；之后每来一个新的数据，就和之前的聚合状态进一步做归约。</p><p>例子：我们将数据流按照用户 id 进行分区，然后用一个 reduce 算子实现 sum 的功能，统计每个用户访问的频次；进而将所有统计结果分到一组，用另一个 reduce 算子实现maxBy 的功能， 记录所有用户中访问频次最高的那个，也就是当前访问量最大的用户是谁。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">ReduceFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransReduceTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这里的使用了之前自定义数据源小节中的ClickSource()</span>
        env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClickSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 将Event数据类型转换成元组类型</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span>f0<span class="token punctuation">)</span> <span class="token comment">// 使用用户名来进行分流</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 每到一条数据，用户pv的统计值加1</span>
                        <span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> value1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 为每一条数据分配同一个key，将聚合结果发送到一条流中去</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value1<span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 将累加器更新为当前最大的pv统计值，然后向下游发送累加器的值</span>
                        <span class="token keyword">return</span> value1<span class="token punctuation">.</span>f1 <span class="token operator">&gt;</span> value2<span class="token punctuation">.</span>f1 <span class="token operator">?</span> value1 <span class="token operator">:</span> value2<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="自定义函数" tabindex="-1"><a class="header-anchor" href="#自定义函数" aria-hidden="true">#</a> 自定义函数</h4><ol><li><p>lambda</p><p>当使用 map() 函数返回 Flink 自定义的元组类型时也会发生类似的问题。下例中的函数签名 <code>Tuple2&lt;String, Long&gt; map(Event value)</code> 被类型擦除为<code>Tuple2 map(Event value)</code>。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">//使用 map 函数也会出现类似问题，以下代码会报错</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stream3 <span class="token operator">=</span> clicks
<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> event <span class="token operator">-&gt;</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
stream3<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解决，多种方式：</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token comment">// 1) 使用显式的 &quot;.returns(...)&quot;</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stream3 <span class="token operator">=</span> clicks
<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> event <span class="token operator">-&gt;</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span><span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>LONG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream3<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2) 使用类来替代 Lambda 表达式</span>
clicks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyTuple2Mapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3) 使用匿名类来代替 Lambda 表达式</span>
clicks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li><li><p>富函数类</p><p>富函数类能获取运行环境的上下文，有生命周期的概念。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RichMapFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransRichFunctionTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> clicks <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./cart&quot;</span><span class="token punctuation">,</span> <span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./prod?id=1&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">&quot;Cary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./home&quot;</span><span class="token punctuation">,</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将点击事件转换成长整型的时间戳输出</span>
        clicks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;索引为 &quot;</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 的任务开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Event</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> value<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;索引为 &quot;</span> <span class="token operator">+</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexOfThisSubtask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 的任务结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li></ol><h3 id="sink" tabindex="-1"><a class="header-anchor" href="#sink" aria-hidden="true">#</a> sink</h3><p>Flink 的 DataStream API 专门提供了向外部写入数据的方法： addSink。与 addSource 类似，addSink 方法对应着一个“Sink”算子，主要就是用来实现与外部系统连接、并将数据提交写入的；Flink 程序中所有对外的输出操作，一般都是利用 Sink 算子完成的。</p><h2 id="第四章-flink部署" tabindex="-1"><a class="header-anchor" href="#第四章-flink部署" aria-hidden="true">#</a> 第四章 Flink部署</h2><h3 id="介绍-1" tabindex="-1"><a class="header-anchor" href="#介绍-1" aria-hidden="true">#</a> 介绍</h3><ol><li><p>当我们如上开发的时候，在开发环境里面其实并没有flink集群，是由我们引入的依赖在IDE里面，也就是集成开发环境里面模拟了一个集群，由上面的输出可知，在本地像上面这样开发的时候，分布式计算是由本地启用多线程来处理的。</p><p>在实际生产中，应该真正意义上启动一个集群，把想要运行的作业、项目，打包好提交上去。</p></li><li><p>flink提交作业和执行任务，需要几个关键组件：</p><ul><li>客户端--client</li><li>作业管理器--JobManager</li><li>任务管理器--TaskManager</li></ul><p>我们的代码<strong>由客户端获取并做转换</strong>，之后提交给JobManager。JobManager是对作业进行中央调度管理的。</p><p>JobManager获取到作业后，会进一步处理转换，然后分发任务给众多的TaskManager，这里的TaskManager，就是真正“干活的人”，数据的处理操作都是他们来做的。</p><p><img src="/study/assets/image-20221121170615233.cbed8cf2.png" alt="image-20221121170615233"></p></li></ol><h3 id="单机部署" tabindex="-1"><a class="header-anchor" href="#单机部署" aria-hidden="true">#</a> 单机部署</h3><ul><li><p>官网下载flink-1.13.0-bin-scala_2.12.tgz</p></li><li><p>上传文件到服务器</p></li><li><p>解压缩</p></li><li><p>修改配置文件</p><ul><li><p>修改conf/flink-conf.yml文件</p><p>修改jobmanager.rpc.address字段的值为服务器地址。</p></li><li><p>修改masters</p><p>masters和workers有主从关系的意思，jobManager是分发任务的，TaskManager是执行任务的，也就是干活的，masters就是当前的JobManager，就配置当前的JobManager的地址和端口。</p><p><strong>这里的端口是可以访问的web服务的端口号。</strong></p></li><li><p>修改workers为执行任务的服务器地址</p></li></ul></li><li><p>启动</p><p>执行启动命令</p><div class="language-bash ext-sh"><pre class="language-bash"><code>bin/start-cluster.sh
</code></pre></div><p>查看进程</p><div class="language-text ext-text"><pre class="language-text"><code>jps
</code></pre></div></li></ul><h3 id="flink-conf-配置" tabindex="-1"><a class="header-anchor" href="#flink-conf-配置" aria-hidden="true">#</a> flink-conf 配置</h3><ul><li><p>jobmanager.memory.process.size</p><p>给jobmanager分配的内存的大小，默认是1600M。</p></li><li><p>taskmanager.memory.process.size</p><p>给jobmanager分配的内存的大小，默认是1728M。</p></li><li><p>taskmanager.numberOfTaskSlots</p><p>任务槽，有几个任务槽就可以并行执行几个任务。默认是1，就是默认只能执行1个任务</p></li><li><p>parallelism.default</p><p>并行度。</p></li></ul><h3 id="向集群提交作业" tabindex="-1"><a class="header-anchor" href="#向集群提交作业" aria-hidden="true">#</a> 向集群提交作业</h3><h4 id="web-ui" tabindex="-1"><a class="header-anchor" href="#web-ui" aria-hidden="true">#</a> web UI</h4><ol><li><p>上传作业</p><p>上传的是打包好的项目，即jar包</p><p><img src="/study/assets/image-20221206153053472.95cead5c.png" alt="image-20221206153053472"></p><p>指定作业的执行入口 EntryClass</p><p><img src="/study/assets/image-20221206154525832.dfba8887.png" alt="image-20221206154525832"></p></li></ol><h4 id="命令行" tabindex="-1"><a class="header-anchor" href="#命令行" aria-hidden="true">#</a> 命令行</h4><div class="language-bash ext-sh"><pre class="language-bash"><code>./bin/flink run xxx.jar
</code></pre></div><p>通过web提交需要输入的参数，通过命令行实现：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>./flink run -c com.atguigu.wc.StreamWordCount -p <span class="token number">1</span> <span class="token punctuation">..</span>/FlinkTutorial-1.0-SNAPSHOT.jar
</code></pre></div><p>取消任务，释放资源(需要指定jobId)：</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@jd bin<span class="token punctuation">]</span><span class="token comment"># ./flink cancel 9869b083511c0b9910b494faadbdf509</span>
Cancelling job 9869b083511c0b9910b494faadbdf509.
Cancelled job 9869b083511c0b9910b494faadbdf509.
</code></pre></div><p>任务槽就相当于是资源，当资源数为0时，再去提交作业，就会报错。</p><h3 id="部署模式" tabindex="-1"><a class="header-anchor" href="#部署模式" aria-hidden="true">#</a> 部署模式</h3><ol><li><p>在一些应用场景中，对于集群资源分配和占用的方式，可能会有特定的需求，flink为各种场景提供了不同的部署模式。</p><ul><li>会话模式</li><li>单作业模式</li><li>应用模式</li></ul><p>他们的区别主要在于：集群的生命周期以及资源的分配方式，以及应用的main方法到底在哪里执行，客户端还是jobmanager。</p></li><li><p>会话模式</p><p>会话模式其实最符合常规思维，我们需要先启动一个集群，保持一个会话，在这个会话中通过客户端提交作业。</p></li></ol><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 64005626+shaileneF@users.noreply.github.com">shailene</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/study/assets/app.041ef42b.js" defer></script>
  </body>
</html>
