<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/icon/111.ico"><title>spring cloud下 | shAilene</title><meta name="description" content="just be simple.">
    <link rel="modulepreload" href="/study/assets/app.dca8cb27.js"><link rel="modulepreload" href="/study/assets/springcloud（下）.html.9b239d5d.js"><link rel="modulepreload" href="/study/assets/springcloud（下）.html.3eb9f61a.js"><link rel="prefetch" href="/study/assets/index.html.0671e64c.js"><link rel="prefetch" href="/study/assets/index.html.8f7efa61.js"><link rel="prefetch" href="/study/assets/index.html.2a1aac65.js"><link rel="prefetch" href="/study/assets/index.html.f8f307c4.js"><link rel="prefetch" href="/study/assets/gin.html.362e009f.js"><link rel="prefetch" href="/study/assets/golang.html.38e97c3b.js"><link rel="prefetch" href="/study/assets/gorm.html.ddad5b38.js"><link rel="prefetch" href="/study/assets/Javaweb.html.7b03e755.js"><link rel="prefetch" href="/study/assets/ES.html.b47e1584.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.c6850945.js"><link rel="prefetch" href="/study/assets/Java笔记.html.a1ee600a.js"><link rel="prefetch" href="/study/assets/dubbo.html.1f109fe8.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.7ec7d3cf.js"><link rel="prefetch" href="/study/assets/zookeeper.html.7af36778.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.a36f6553.js"><link rel="prefetch" href="/study/assets/并发编程.html.4e43edad.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.65960cb8.js"><link rel="prefetch" href="/study/assets/redis.html.c15a7351.js"><link rel="prefetch" href="/study/assets/Mybatis.html.4eeab7f1.js"><link rel="prefetch" href="/study/assets/spring.html.923009ce.js"><link rel="prefetch" href="/study/assets/springboot.html.9dba99ad.js"><link rel="prefetch" href="/study/assets/springboot.html.444914ea.js"><link rel="prefetch" href="/study/assets/springMVC.html.709dd336.js"><link rel="prefetch" href="/study/assets/kafka.html.256d71a5.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.8cf47fc5.js"><link rel="prefetch" href="/study/assets/操作系统.html.7de0368d.js"><link rel="prefetch" href="/study/assets/flink基本篇1.html.7b5d42f8.js"><link rel="prefetch" href="/study/assets/flink基本篇2.html.7ca32fef.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.27955756.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.d8169839.js"><link rel="prefetch" href="/study/assets/404.html.93146c89.js"><link rel="prefetch" href="/study/assets/index.html.8edddcfb.js"><link rel="prefetch" href="/study/assets/index.html.14f9409b.js"><link rel="prefetch" href="/study/assets/index.html.f7b6da4a.js"><link rel="prefetch" href="/study/assets/index.html.b1e62ab2.js"><link rel="prefetch" href="/study/assets/gin.html.5b39aabb.js"><link rel="prefetch" href="/study/assets/golang.html.7e69d48f.js"><link rel="prefetch" href="/study/assets/gorm.html.df9affe7.js"><link rel="prefetch" href="/study/assets/Javaweb.html.0a7c1707.js"><link rel="prefetch" href="/study/assets/ES.html.b0a251be.js"><link rel="prefetch" href="/study/assets/一些知识点的记录.html.db77cfc0.js"><link rel="prefetch" href="/study/assets/Java笔记.html.29faecff.js"><link rel="prefetch" href="/study/assets/dubbo.html.49d30a6a.js"><link rel="prefetch" href="/study/assets/springcloud（上）.html.c143ae24.js"><link rel="prefetch" href="/study/assets/zookeeper.html.1433faa9.js"><link rel="prefetch" href="/study/assets/《并发编程的艺术》笔记.html.529db9cd.js"><link rel="prefetch" href="/study/assets/并发编程.html.73ef0ab1.js"><link rel="prefetch" href="/study/assets/尚硅谷_宋红康_JDBC.html.d20af378.js"><link rel="prefetch" href="/study/assets/redis.html.73ce2421.js"><link rel="prefetch" href="/study/assets/Mybatis.html.06cb661b.js"><link rel="prefetch" href="/study/assets/spring.html.77350dfa.js"><link rel="prefetch" href="/study/assets/springboot.html.6a3d5aa0.js"><link rel="prefetch" href="/study/assets/springboot.html.2c33995d.js"><link rel="prefetch" href="/study/assets/springMVC.html.3eee4988.js"><link rel="prefetch" href="/study/assets/kafka.html.c4699eeb.js"><link rel="prefetch" href="/study/assets/RabbitMQ.html.2c0714af.js"><link rel="prefetch" href="/study/assets/操作系统.html.aaff9871.js"><link rel="prefetch" href="/study/assets/flink基本篇1.html.2146077c.js"><link rel="prefetch" href="/study/assets/flink基本篇2.html.4c7ecb83.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第一部分.html.16daa6d5.js"><link rel="prefetch" href="/study/assets/MySQL数据库笔记-第二部分.html.ca16042a.js"><link rel="prefetch" href="/study/assets/404.html.e9aeee6f.js"><link rel="prefetch" href="/study/assets/404.bbf6b601.js"><link rel="prefetch" href="/study/assets/Layout.684fa661.js">
    <link rel="stylesheet" href="/study/assets/style.2bba04cf.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/study/" class=""><img class="logo" src="/study/images/leo.jpg" alt="shAilene"><span class="site-name can-hide">shAilene</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/study/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/study/java/" class="router-link-active" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/go/" class="" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/mw/" class="" aria-label="中间件"><!--[--><!--]--> 中间件 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/study/Design-patterns/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">spring cloud下 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#六、服务网关" class="router-link-active router-link-exact-active sidebar-item" aria-label="六、服务网关"><!--[--><!--]--> 六、服务网关 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#zuul" class="router-link-active router-link-exact-active sidebar-item" aria-label="zuul"><!--[--><!--]--> zuul <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#gateway" class="router-link-active router-link-exact-active sidebar-item" aria-label="gateway"><!--[--><!--]--> gateway <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#特性" class="router-link-active router-link-exact-active sidebar-item" aria-label="特性"><!--[--><!--]--> 特性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#三大核心概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="三大核心概念"><!--[--><!--]--> 三大核心概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#gateway工作流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="gateway工作流程"><!--[--><!--]--> gateway工作流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#网关配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="网关配置"><!--[--><!--]--> 网关配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#动态路由" class="router-link-active router-link-exact-active sidebar-item" aria-label="动态路由"><!--[--><!--]--> 动态路由 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#predicate" class="router-link-active router-link-exact-active sidebar-item" aria-label="Predicate"><!--[--><!--]--> Predicate <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#filter" class="router-link-active router-link-exact-active sidebar-item" aria-label="Filter"><!--[--><!--]--> Filter <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#七、服务配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="七、服务配置"><!--[--><!--]--> 七、服务配置 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#config-server" class="router-link-active router-link-exact-active sidebar-item" aria-label="Config Server"><!--[--><!--]--> Config Server <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-4" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#作用" class="router-link-active router-link-exact-active sidebar-item" aria-label="作用"><!--[--><!--]--> 作用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#使用springcloud-config" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用springcloud config"><!--[--><!--]--> 使用springcloud config <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#配置中心-服务端" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置中心（服务端）"><!--[--><!--]--> 配置中心（服务端） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#客户端" class="router-link-active router-link-exact-active sidebar-item" aria-label="客户端"><!--[--><!--]--> 客户端 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="问题"><!--[--><!--]--> 问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#解决" class="router-link-active router-link-exact-active sidebar-item" aria-label="解决"><!--[--><!--]--> 解决 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#八、服务总线" class="router-link-active router-link-exact-active sidebar-item" aria-label="八、服务总线"><!--[--><!--]--> 八、服务总线 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-5" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#spring-cloud-bus" class="router-link-active router-link-exact-active sidebar-item" aria-label="Spring cloud Bus"><!--[--><!--]--> Spring cloud Bus <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-6" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#通过bus实现全局广播" class="router-link-active router-link-exact-active sidebar-item" aria-label="通过bus实现全局广播"><!--[--><!--]--> 通过bus实现全局广播 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#设计思想" class="router-link-active router-link-exact-active sidebar-item" aria-label="设计思想"><!--[--><!--]--> 设计思想 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#设计实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="设计实现"><!--[--><!--]--> 设计实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#动态刷新定点通知" class="router-link-active router-link-exact-active sidebar-item" aria-label="动态刷新定点通知"><!--[--><!--]--> 动态刷新定点通知 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#九、消息驱动" class="router-link-active router-link-exact-active sidebar-item" aria-label="九、消息驱动"><!--[--><!--]--> 九、消息驱动 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#spring-cloud-stream" class="router-link-active router-link-exact-active sidebar-item" aria-label="spring cloud stream"><!--[--><!--]--> spring cloud stream <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#设计思想-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="设计思想"><!--[--><!--]--> 设计思想 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#标准流程套路及注解" class="router-link-active router-link-exact-active sidebar-item" aria-label="标准流程套路及注解"><!--[--><!--]--> 标准流程套路及注解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#案例说明" class="router-link-active router-link-exact-active sidebar-item" aria-label="案例说明"><!--[--><!--]--> 案例说明 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#新建三个子module" class="router-link-active router-link-exact-active sidebar-item" aria-label="新建三个子module"><!--[--><!--]--> 新建三个子module <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#生产者" class="router-link-active router-link-exact-active sidebar-item" aria-label="生产者"><!--[--><!--]--> 生产者 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#消费者" class="router-link-active router-link-exact-active sidebar-item" aria-label="消费者"><!--[--><!--]--> 消费者 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#分组消费" class="router-link-active router-link-exact-active sidebar-item" aria-label="分组消费"><!--[--><!--]--> 分组消费 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#持久化" class="router-link-active router-link-exact-active sidebar-item" aria-label="持久化"><!--[--><!--]--> 持久化 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#spring-cloud-alibaba" class="router-link-active router-link-exact-active sidebar-item" aria-label="Spring Cloud Alibaba"><!--[--><!--]--> Spring Cloud Alibaba <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#十、nacos" class="router-link-active router-link-exact-active sidebar-item" aria-label="十、Nacos"><!--[--><!--]--> 十、Nacos <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-7" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#nacos做注册中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="nacos做注册中心"><!--[--><!--]--> nacos做注册中心 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#服务提供者" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务提供者"><!--[--><!--]--> 服务提供者 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#服务消费者" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务消费者"><!--[--><!--]--> 服务消费者 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#nacos做配置中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="nacos做配置中心"><!--[--><!--]--> nacos做配置中心 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-8" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#基础配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="基础配置"><!--[--><!--]--> 基础配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#分类配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="分类配置"><!--[--><!--]--> 分类配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#nacos集群和持久化配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="nacos集群和持久化配置"><!--[--><!--]--> nacos集群和持久化配置 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-9" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置"><!--[--><!--]--> 配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#sentinel实现熔断与限流" class="router-link-active router-link-exact-active sidebar-item" aria-label="Sentinel实现熔断与限流"><!--[--><!--]--> Sentinel实现熔断与限流 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#概述-10" class="router-link-active router-link-exact-active sidebar-item" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#微服务集成sentinel" class="router-link-active router-link-exact-active sidebar-item" aria-label="微服务集成sentinel"><!--[--><!--]--> 微服务集成sentinel <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#流控规则" class="router-link-active router-link-exact-active sidebar-item" aria-label="流控规则"><!--[--><!--]--> 流控规则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#熔断降级" class="router-link-active router-link-exact-active sidebar-item" aria-label="熔断降级"><!--[--><!--]--> 熔断降级 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#热点规则" class="router-link-active router-link-exact-active sidebar-item" aria-label="热点规则"><!--[--><!--]--> 热点规则 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#sentinelresource" class="router-link-active router-link-exact-active sidebar-item" aria-label="@SentinelResource"><!--[--><!--]--> @SentinelResource <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/study/java/%E5%88%86%E5%B8%83%E5%BC%8F/springcloud/springcloud%EF%BC%88%E4%B8%8B%EF%BC%89.html#服务熔断功能" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务熔断功能"><!--[--><!--]--> 服务熔断功能 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="spring-cloud下" tabindex="-1"><a class="header-anchor" href="#spring-cloud下" aria-hidden="true">#</a> spring cloud下</h1><h2 id="六、服务网关" tabindex="-1"><a class="header-anchor" href="#六、服务网关" aria-hidden="true">#</a> 六、服务网关</h2><h3 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h3><ol><li>服务网关进行日志、限流、权限、安全等等操作。</li></ol><h3 id="zuul" tabindex="-1"><a class="header-anchor" href="#zuul" aria-hidden="true">#</a> zuul</h3><ol><li><p>springcloud中集成的zuul版本，采用的是tomcat容器，使用的是传统的servlet io处理模型。</p></li><li><p>servlet是tomcat的核心组件之一，另外两个组件是监听器和过滤器。</p></li><li><p>servlet是由servlet container进行生命周期管理</p></li><li><p>servlet的生命周期：</p><ul><li>container启动时构造servlet对象并调用**servlet init()**进行初始化</li><li><strong>container运行时接受请求，并为每个请求分配一个线程（一般从线程池中获取空闲线程），然后调用service()</strong></li><li>container关闭时调用**servlet destroy()**消费servlet。</li></ul></li><li><p>servlet是一个简单的网络IO模型，当请求进入servlet container时，servlet container就会为其绑定一个线程，在并发不高的场景下，这种模型是适用的，但是一旦高并发，线程数量就会上涨，而线程资源代价是昂贵的（上下文切换造成内存消耗大），严重影响请求的处理时间。在一些简单业务场景下，不希望为每个请求分配一个线程，<strong>只需要1个或几个线程就能应对极大并发请求</strong>，这种业务场景下servlet模型没有优势。</p><p>所以Zuul 1.X是基于servlet的一个阻塞式处理模型，即spring实现了处理所有request请求的一个servlet（DispatcherServlet），是阻塞式处理模型。</p></li><li><p>传统的Web框架，比如说strust2，springmvc等都是基于Servlet API与servlet容器基础之上运行的。</p><p>在servlet3.1之后有了异步非阻塞的支持，而webflux是一个典型异步非阻塞的框架，他的核心是基于Reactor的相关API实现的。</p><p>Spring WebFlux是spring5.0引入的新的响应式框架，区别于Spring MVC，它不需要依赖于Servlet API，它是完全异步非阻塞的，并且基于Reactor来实现响应式流规范。</p></li></ol><h3 id="gateway" tabindex="-1"><a class="header-anchor" href="#gateway" aria-hidden="true">#</a> gateway</h3><h4 id="概述-1" tabindex="-1"><a class="header-anchor" href="#概述-1" aria-hidden="true">#</a> 概述</h4><ol><li><p>springcloud gateway是springcloud生态系统中的网关，目标是替代zuul。</p></li><li><p><strong>springcloud gateway是基于WebFlux框架实现的，WebFlux框架是非阻塞式的web框架，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty。</strong></p></li><li><p>Springcloud gateway的目标是提供统一的路由方式，且基于Filter链的方式提供了网关基本的功能，如安全、监控和限流。</p><p><img src="/study/assets/image-20220412183425220.f3243c73.png" alt="image-20220412183425220"></p></li><li><p>可以理解为网关是所有微服务的入口。</p></li><li><p><strong>gateway是基于异步非阻塞模型开发的。</strong></p></li></ol><h4 id="特性" tabindex="-1"><a class="header-anchor" href="#特性" aria-hidden="true">#</a> 特性</h4><ol><li>动态路由：能够匹配任何请求属性</li><li>可以对路由指定Predicate（断言）和Filter（过滤器）</li><li>集成Hystrix的断路器功能</li><li>集成Springcloud服务发现功能</li><li>请求限流功能</li><li>支持路径重写</li></ol><h4 id="三大核心概念" tabindex="-1"><a class="header-anchor" href="#三大核心概念" aria-hidden="true">#</a> 三大核心概念</h4><ol><li><p>路由（Route）</p><p>路由是构建网关的基本模块，<strong>它由ID，目标URI，一系列的断言和过滤器组成</strong>，如果断言为true则匹配该路由。</p></li><li><p>断言（Predicate）</p><p><strong>开发人员可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由。</strong></p><p><strong>predicate就可以理解为匹配条件，定位到真正的服务节点。</strong></p><p><strong>Springcloud gateway包括许多内置的RoutePredicateFactories，所有这些Predicate都与Http请求的不同属性匹配，多个Predicate工厂可以进行组合。</strong></p></li><li><p>过滤器（Filter）</p><p>使用过滤器，可以在请求被路由前或者后对请求进行修改。</p></li></ol><h4 id="gateway工作流程" tabindex="-1"><a class="header-anchor" href="#gateway工作流程" aria-hidden="true">#</a> gateway工作流程</h4><ol><li><p>客户端向spring cloud gateway发出请求，然后在<strong>gateway handler mapping</strong>中找到与请求相匹配的路由，将其发送到<strong>gateway web handler</strong>。</p><p>handler再通过指定的过滤器链将请求发送到我们实际的服务执行业务逻辑。</p><p>过滤器可能会在发送代理请求之前或之后执行过滤器逻辑。</p><p>“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等。</p><p>“post”类型的过滤器中可以做响应内容、响应头的修改，日志输出，流量监控等。</p></li></ol><h4 id="网关配置" tabindex="-1"><a class="header-anchor" href="#网关配置" aria-hidden="true">#</a> 网关配置</h4><h5 id="在application-yml中配置" tabindex="-1"><a class="header-anchor" href="#在application-yml中配置" aria-hidden="true">#</a> 在application.yml中配置</h5><ol><li><p>建module</p></li><li><p>修改pom</p><p><strong>要注意网关作为一种微服务，也要注册进注册中心</strong></p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--引入公共实体类项目的jar包坐标--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.springcloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cloud-api-commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--热部署--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意，gateway网关微服务，不要引入以下jar包，不需要</p><div class="language-xml ext-xml"><pre class="language-xml"><code>        <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>不然启动会报错</p><p><img src="/study/assets/image-20220412224900162.1ade3bd3.png" alt="image-20220412224900162"></p></li><li><p>修改application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>service
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">## 表示是否将自己注册进eureka server</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## 表示是否从eureka server抓取已有的注册信息，默认为true</span>
    <span class="token comment">## 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetchRegistry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayMain9527</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayMain9527</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>配置好网关之后，如何做路由映射？</p><p>修改yml配置文件如下：</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span> <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span> <span class="token comment">#断言，路径相匹配的进行路由</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8001</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>
</code></pre></div><p><strong>做了以上配置，9527就挡在了8001的前面。</strong></p></li><li><p>添加网关前：http://localhost:8001/payment/get/31</p><p>添加网关后：http://localhost:9527/payment/get/31</p><p>添加网关后，就通过网关作为微服务的入口，调用微服务。</p></li></ol><h5 id="代码中注入routelocator的bean" tabindex="-1"><a class="header-anchor" href="#代码中注入routelocator的bean" aria-hidden="true">#</a> 代码中注入RouteLocator的Bean</h5><ol><li><p>添加配置类GateWayConfig</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GateWayConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> routeLocatorBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RouteLocatorBuilder<span class="token punctuation">.</span>Builder</span> routes <span class="token operator">=</span> routeLocatorBuilder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 访问9527服务的path为guonei,则会转发到&quot;http://news.baidu.com/guonei&quot;这个url</span>
        routes<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;path_route_atguigu1&quot;</span><span class="token punctuation">,</span>
                r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/guonei&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://news.baidu.com/guonei&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> routes<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="动态路由" tabindex="-1"><a class="header-anchor" href="#动态路由" aria-hidden="true">#</a> 动态路由</h4><ol><li><p>以前服务消费者直接调用服务提供者，我们通过Ribbon + RestTemplate来进行服务调用并实现负载均衡。或者通过OpenFeign来进行服务调用，Feign内置了Ribbon。</p><p>现在在服务提供者前面，有一个网关，我们通过网关，来进行服务调用，通过网关来作为微服务调用的入口，而网关的端口一般是9527，所以服务消费者访问的是9527端口，<strong>那么需要通过网关来做负载均衡。</strong></p><p>服务的提供者，也就是微服务可以部署在多台服务器上，避免单点故障，都是分布式的部署方式。我们只需要找网关，由网关来做负载均衡，消费者只认挡在微服务前面的9527。</p></li><li><p>通过微服务名实现动态路由。</p><p>默认情况下GateWay会根据注册中心注册的服务列表，以注册中心上微服务名为路径<strong>创建动态路由</strong>进行转发，从而实现动态路由的功能。</p><p>修改gateway9527微服务的application.yml如下</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启从注册中心获取注册服务列表，根据服务名创建动态路由的功能，利用微服务名进行路由</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
<span class="token comment">##          uri: http://localhost:8001 #匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span> <span class="token comment">#断言，路径相匹配的进行路由</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
<span class="token comment">##          uri: http://localhost:8001</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>service
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">## 表示是否将自己注册进eureka server</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## 表示是否从eureka server抓取已有的注册信息，默认为true</span>
    <span class="token comment">## 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetchRegistry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka
</code></pre></div><p>把以前写死的uri地址，换成<code>lb</code>+“微服务名称”</p><p><code>uri: lb://cloud-payment-service</code></p></li><li><p>测试</p><p><img src="/study/assets/image-20220413155206740.8a60d22a.png" alt="image-20220413155206740"></p></li></ol><h4 id="predicate" tabindex="-1"><a class="header-anchor" href="#predicate" aria-hidden="true">#</a> Predicate</h4><ol><li><p><strong>Springcloud gateway包括许多内置的RoutePredicateFactories，所有这些Predicate都与Http请求的不同属性匹配，多个Predicate工厂可以进行组合。</strong></p><p><strong>可以把Route Predicate理解为路由匹配。多个路由匹配相组合。不同的路由匹配对应于Http请求的不同属性。</strong></p><p><strong>Springcloud gateway创建动态路由时，使用RoutePredicateFactory创建Predicate对象，Predicate对象可以赋值给Route。</strong></p></li></ol><h4 id="filter" tabindex="-1"><a class="header-anchor" href="#filter" aria-hidden="true">#</a> Filter</h4><h5 id="概述-2" tabindex="-1"><a class="header-anchor" href="#概述-2" aria-hidden="true">#</a> 概述</h5><ol><li><p>过滤器可用于修改http请求和返回的http响应。</p></li><li><p>Springcloud gateway内置了多种路由过滤器对象，他们都由GatewayFilter工厂来生产。</p></li><li><p>使用方式：</p><p>和predicate路由匹配一样，在yml配置文件中进行修改</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启从注册中心获取注册服务列表，根据服务名动态创建路由的功能，利用微服务名进行路由</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
<span class="token comment">##          uri: http://localhost:8001 #匹配后提供服务的路由地址</span>
          <span class="token key atrule">filter</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestParameter=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span><span class="token number">1024</span> <span class="token comment">#过滤器会在匹配的请求头加上一个键值对参数，名称为X-Request-Id，值为1024</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span> <span class="token comment">#断言，路径相匹配的进行路由</span>
</code></pre></div></li></ol><h5 id="自定义过滤器" tabindex="-1"><a class="header-anchor" href="#自定义过滤器" aria-hidden="true">#</a> 自定义过滤器</h5><ol><li><p>实际工作中，用自定义过滤器多一些。</p></li><li><p><strong>自定义全局GlobalFilter，实现两个接口--GlobalFilter，Ordered。</strong></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASoAAABECAIAAAC50e/mAAALxklEQVR4nO2df0xb1xXHzzU4CX5NyIoZNQn2g5KGBKaBWco0DF0XiU4KNMpEEqmkTtj+SNNVjfgjrNKaUpZGmmilKJuqEE0bIz9LgpapDtNGlbaAqcoqG7ZCAgsF2yQ4CSZtSJ6BOPjuj2cb2zwbnNg8Y85H/sPvvfvjvKv7fffcc599ycTEBCAIIgYSsQ1AkOULyg9BRAPlhyCigfJDENFA+SGIaMSLbQAAwOidcfvUlOcwPi4u+em1TMIqEU1CkEUgKka/m7dt31hGPZ+B4ZEvjL2mm7ceoyhqPvPK84XqAs0rp8zttYV5r54xUQoA3t8RJEqIitFvLk5KB4ZHnE5nRlrqwnNRqq/ZeQLeOGfUqig1N2ojZyCChIEolR/PdfPN6+abgpeeTlyz5Qcb/c9aTIPwXMkLSgAgRLXvdOc+obyU6msKfgMf6H9XTMJrMIKERDidzzt37pw+ffrevXtzLw0NDZ0/f37Ka4IXEczD1yJbAYKEk3DKj+O4u3fvXrhwwU+BQ0NDOp3uwYMH09PTYazOj/bawvxD/yLk+h92FeU9X/lXMxWc75lOVeb/+K3LhFw+VMRPEfnznkmjukDjnYsvpP1Upd95BHlywim/9PT0srIyu93urUBeezKZbNeuXYmJifMWIpXG52xIL1Tn5GxIXyGVLrz24ppOw/svUbrhzQsd3f9u2KcSdixZbYPhy9+XUlr6foexS39OqwIA2n5EvfNKyUW9sUtv+PLsQTixQ3vWozTyv/qDw78ydum7T+9hCfqrSNgIc+QzIyPDW4Ghag8AsjPZdSnyp2QJ61Lkm59Vhtc8QSg1N/7pn2Uf/IVXLCGqve8d2DRw5XOLJ8FLx98pXARLkOVG+EMvvAJ1Ot1HH300NTUVkvYAQP69RK/va8NungCWjtYB6D9UdNn7JIFMM4AKAAA2pi/GYwBZfkQk8ulRYKjaA4AHnD1x9VOu73Z7JMwTpPT9DgyEIotMpJbdMzIytm/fHqr2AKBv0MxNTgEANznVN2iOjHW+KNlMgEGTZf6UCBJWIvjWC8uyoWoPAO5zdr3h60+7uvWGr+9zERz9PHojRPPLN57r/7DinXZXrIWaz7xSq49c1QjCE6XL7g7Ho8gVToim9oOf5x+qUH8IWb8+e06rYrUNf4PKX7inf/S51y6dwlgLEnFINPzZxFdfD9y9F5oZwm+9IMiSIipGv6wM5aOZ0Ia7+LiosBxBnoSo6MSrmQSxTUAQEYiKHxwhyPIE5YcgooHyQxDRQPkhiGig/BBENFB+CCIaKD8EEQ2UH4KIBsoPQUQD5YcgohE/MjIitg0IskzB0Q9BRAPlhyCigfJDENFA+SGIaKD8EEQ0UH4IIhooPwQRjaj4s4nw4qAw6oi7/RCmQAIAq8CZsgJSpTNS/BNdJMqIKflRgP6p+KuTcdNO732I4ganYaUkfnPCTNaqR6hBJHqIHefzIYXPJqTdnMRXey6mnbSbk3w2IX2IG4RFAWP12R1vN3KU+n1fbsTI6EcB9PeltxzzjG23HER/X/riGuF0nK6i+2IPVVarj2iZORuJjdVnD3wBSQd7N+UHq4XTVRibMrNOv5sc7q3IKG3vf/XAuPuBSX9youi14vBWEXb4JvU+k3SwN0tttt8Qy6LoIkbk1z8VP6/2eG45SP9U/KZVwn8rSpW5jKnVZtUyvlvK09HGEX2ujO0RzLUI8P04qapX4xY/NdR01ENwBfKKhap5HhkRhTrL5zyMWNV7fSrBxFFg8GISC/JzULg6GQfg473cvvafe5Zvpu59K5OnKH74PJP0fc+lq5NxmSsfCUdiTJkJmmbLxx0q325tN7Rymky5Xhz5UUONsQmUdb2q1FmjSX5tUb4o5iBhIxbmflaHb6yF0mu68998qiNxcYnr2emJb69+fM7pnPFcn3ZSqyMuUGnyl6sZ/Unz6GyBlLZbmkD58lbPmbnTlYVMYOhoo3FPtl7r+lwz+CSmhhrPJaOu3fx2dkd9OwBQarJcamZ2H/XWnn/J1GR+25W3Y0/NGKUAwOkqOvceGJfA+PEcvTbbqDPNNSPQBEzg0G3M3IoeozUEE4RksKeQMV2F3/klRCyMfrcdvofXer67MfyjfW+uYNbwZ+jMIyKJ88uiXBGgOIU2TVM3YjCrUln+hP3ySZtmv0YB/e4k8i3loJ/1USltt+lBXqVlCOEClEoNNZ3Hm5OqetX5BADoaGN3dY5xd4u6jAWPb+meWI7VZw9YANYDAIC1bdwECTsEnTVwW9gAr/dqUgmlJsvhbf2HM2RHtEzZ2cJSf1+OGmr0xwaVdb1qd2LjYVAf0XrfEX87AJ5Dk/0GyHcUBaroMVpDkJAM5ifnxFLXv/5E0alonwMHIhZGv0mnz118ZxqUb8j2aA8AyJwNIfyy+CHfUs41NfCPdkrbLU098i1FPinUlUq2Z9zg3n7QeMUG5XJ1wAIpbe8/1izb2eLpVSR178bduXwtfBXeV+X7W9I8G+pahzjIlSlmi7q2x3/8Ycpq+bGREFa5oxxMQ4I7s/EDqbzqzGzi16sZU6vNCqDeKoceu9VzO7mM5watbeMmlwHCFQVtDSJpHtib42fwAglmMJ/AWZ61vyhYEdFNLIx+AjyhH6KuVLLbRi5XJpexYLxiY6vVvtIihJUX5Fq62rhSlQzMlkvNzO6WYKFO6/AkQEKqzwgmS80EGLRbAUDg6iyKDAYGvaou3nSmD1wh1tlUfGDWTXkAM9rGTWA/nuOzd6EEEqxAUovlGuj/qgPyi+2jg6DZv3HdSWNXG1eqAkMrx5ZsdOt/bkXBW0Mo9LJgAhsMfGyMzZA9TrnRQizIL0HiBJj1LdeymUOf/yOt4Ker1ri2hufGrEyyYk6WgHj1J7BdamYKWhhC/BQtyy9hmlptVq0S2sZNuUmvB3MOnwhFegL0jHs5w37w0UIbuHo5NdTojwUrL9DaiWxdLnQNc1Rp6+qR7yiSKYaZpiE7ANzsYQqOMoQEqSiirTHvYs/SJRaczxSp7+Gm3NWpSuOpP17/5O8m/Sfd50/+98KfH01NBskyF1npfrmpznKywWIqTysV6kyKF5LYnnGD2W5o5dgSuUIgiVfi9ASAyVGfvbLto4MAmTKF4FWL3RV3AEKKlW43Vbhw4xUb5CrrXCOMfXRQOFkAMzzI8ksYU6vN2DZuKper+Rtsthk7bPrcpHzVPBWF1BoLJ6jBMUAsyE8hnVkp8Xo6EpKzfc+zPyudefiQG7OuTUtXa9+IXzW7h9lKCVFIZwQK8oLv9ONfNDO7KwUdJ37yw3U1WLp65DsElunnlma/uM0T7aSGmu6LPfKqd5MJIaRYrgGu6beecKvt5OzyOgDISo8q2eb+V/d4x2PtN2dXQYjENW2jo40DTf6rI57uK2DGaKOxvt2VTvFCEttj/2qI02xNJoR3AWyXTk56ySlQRSG1xrws1OClTyw4n1ICmxNmujmvDktIyua8lM15guk3Jyzo9WtZfomsCVwPfkHUW+XHDtigPMtvZihpHtjbPOA+5F9PYcrOFqbWdLqnMdSZ672Ol/xaH0D2wFs5/P9eJR1sSbuxzTJ7N6zqvT6loabTnQC851T5tXk7B7uP5+gBqLJaXVVuPObJWJxVVd55fJv+Ish2tqjLWKbsbB5UdHvMUFarjxR5apEX5HZfbJYffNfTAkxTHew+6gozBq4oSGuEREgGxwCkr69PbBvCAAX4bGL+l84A4BkpDfTSWciVUpPl8DbL+vC//BW5kiPHUrRZdGLB+QQAAqBZ7XhGOk/A8xkp1awOj/YAXBF55csReBhb28ZN4L/aEeVErjVilxiRHwCsIPDiGkce4/SZB7pZKSF5jPPFNY4V4Quh2T6u4zT7g7yMsnA4XcXsSx60vb+6jmOrlU/gxS0+YWyN5UOMOJ/eLMLPbYP/NuLx8F5PWxK/ZvAQidZYJsSg/BBkqRA7zieCLDlQfggiGig/BBENlB+CiAbKD0FEA+WHIKKB8kMQ0UD5IYhokImJCbFtQJBlyv8BHaMKA2JtWF8AAAAASUVORK5CYII=" alt="image-20220413172539581"></p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogGatewayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;********come in MyLogGatewayFilter:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uname <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;uname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;****用户名为null，非法用户&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>NOT_ACCEPTABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//通过之后，去下一个过滤器</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>exchange当作是request、response。</p><p>chain是过滤器链</p><p><img src="/study/assets/image-20220413173122373.3a494ea5.png" alt="image-20220413173122373"></p><p>如果request不带uname参数，那么就是非法用户。</p><p><img src="/study/assets/image-20220413173159980.c734ee27.png" alt="image-20220413173159980"></p><div class="language-text ext-text"><pre class="language-text"><code>2022-04-13 17:31:52.504  INFO 2180 --- [ctor-http-nio-2] c.a.s.filter.MyLogGatewayFilter          : ****用户名为null，非法用户
</code></pre></div><p>注意：因为这是get请求，所以在浏览器的地址栏中能直接这样写，能直接通过浏览器地址栏去发送请求，那么是get请求，post请求不能通过这种方式去发送。</p></li></ol><h2 id="七、服务配置" tabindex="-1"><a class="header-anchor" href="#七、服务配置" aria-hidden="true">#</a> 七、服务配置</h2><h3 id="概述-3" tabindex="-1"><a class="header-anchor" href="#概述-3" aria-hidden="true">#</a> 概述</h3><ol><li><p>alibaba的nacos能做服务注册中心、服务配置、服务总线，所以到后面统一整理。</p></li><li><p>在实际生产中有很多微服务，我们要将他们的配置进行统一管理，因为可能他们用到的数据库、注册中心等配置是一样的，所以要统一管理，一处修改，处处生效。</p></li><li><p>实际开发中，有生产环境、测试环境、开发环境。</p></li><li><p>微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息，所以一套集中式的、动态的配置管理设施是必不可少的。</p><p>问题：每一个微服务自己带着一个application.yml，实际开发中存在上百个文件的配置管理。</p><p>Springcloud提供了Config Server来解决这个问题。</p></li></ol><h3 id="config-server" tabindex="-1"><a class="header-anchor" href="#config-server" aria-hidden="true">#</a> Config Server</h3><h4 id="概述-4" tabindex="-1"><a class="header-anchor" href="#概述-4" aria-hidden="true">#</a> 概述</h4><ol><li><p>springcloud config为微服务架构中的微服务提供<strong>集中化</strong>的外部配置支持，config server为各个不同微服务应用的所有环境提供了一个中心化的外部配置。</p><p>公有的配置放在config server里，私有的配置，各微服务自己配置。</p></li><li><p><strong>springcloud config分为服务端和客户端两部分。</strong></p><p>服务端也就是分布式配置中心，<strong>它是一个独立的微服务应用</strong>，为客户端提供配置信息。</p><p>客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息。</p><p>配置中心默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便地管理和访问配置内容。</p></li></ol><h4 id="作用" tabindex="-1"><a class="header-anchor" href="#作用" aria-hidden="true">#</a> 作用</h4><ol><li>集中管理配置文件</li><li>不同环境不同配置，比如dev/test/prod/beta/release</li><li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，<strong>服务会向配置中心统一拉取配置自己的信息。</strong></li><li>当配置发生变动时，服务不再需要重启即可感知到配置的变化并应用新的配置。</li><li>将配置信息以REST接口的形式暴露。</li></ol><h3 id="使用springcloud-config" tabindex="-1"><a class="header-anchor" href="#使用springcloud-config" aria-hidden="true">#</a> 使用springcloud config</h3><h4 id="配置中心-服务端" tabindex="-1"><a class="header-anchor" href="#配置中心-服务端" aria-hidden="true">#</a> 配置中心（服务端）</h4><ol><li><p>新建一个本地仓库项目，取名为springcloud-config，和git远程仓库相连，用来存储配置。</p><p>在此项目中，修改配置，并推送至远程仓库，实现配置的版本控制。</p></li><li><p>新建module：cloud-config-center-3344</p></li><li><p>修改pom文件</p><div class="language-xml ext-xml"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--热部署--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>修改application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center <span class="token comment">#注册进eureka注册中心的服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/shaileneF/springcloud<span class="token punctuation">-</span>config.git
          <span class="token comment">##搜索目录</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> springcloud<span class="token punctuation">-</span>config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> xxx
          <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx
      <span class="token comment">#### 读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> main

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainAppConfigCenter3344</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MainAppConfigCenter3344</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="客户端" tabindex="-1"><a class="header-anchor" href="#客户端" aria-hidden="true">#</a> 客户端</h4><ol><li><p>新建module</p></li><li><p>修改pom</p><div class="language-xml ext-xml"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--热部署--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>新建bootstrap.yml</p><p>application.yml是用户级的资源配置项</p><p>bootstrap.yml是系统级别的，优先级更高</p><p>boostrap属于高优先级，相当于客户端微服务通过bootstrap.xml读取共同的外部配置文件，application.yml则是自己私有的配置文件。</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client <span class="token comment">#注册进eureka注册中心的服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token comment">#### 读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> main <span class="token comment">#分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> config <span class="token comment">#配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev <span class="token comment">#读取后缀名称</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344</span> <span class="token comment">#配置中心地址</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientMain3355</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientMain3355</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>业务类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li><li><p>测试</p><p><img src="/study/assets/image-20220413223635965.58bf4466.png" alt="image-20220413223635965"></p></li></ol><h4 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h4><ol><li>修改github上的配置文件内容，config server配置中心立刻响应，config client客户端没有任何响应，难道每次修改github上的配置文件，客户端都要重启？</li></ol><h4 id="解决" tabindex="-1"><a class="header-anchor" href="#解决" aria-hidden="true">#</a> 解决</h4><ol><li><p>修改config client</p></li><li><p>修改pom文件</p><p>添加以下两个依赖</p><div class="language-xml ext-xml"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>修改bootstrap.yml文件，暴露监控端点</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre></div></li><li><p>Controller类添加此注解</p><p>@RefreshScope</p></li><li><p>运维发送post请求刷新config client</p><div class="language-text ext-text"><pre class="language-text"><code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;
</code></pre></div></li></ol><h2 id="八、服务总线" tabindex="-1"><a class="header-anchor" href="#八、服务总线" aria-hidden="true">#</a> 八、服务总线</h2><h3 id="概述-5" tabindex="-1"><a class="header-anchor" href="#概述-5" aria-hidden="true">#</a> 概述</h3><ol><li><p>什么是总线</p><p>在微服务架构的系统中，通常会使用轻量级的消息代理，来构建一个共用的<strong>消息主题</strong>，并让系统中所有微服务实例都**连接（订阅）**上来。由于该主题中产生的消息会被所有订阅的微服务实例监听和消费，所以称它为消息总线。</p></li><li><p>ConfigClient实例都监听MQ中同一个topic（默认是springCloudBus），当一个服务刷新数据的时候，它会把这个消息生产到topic中，这样其他订阅此topic的微服务就能得到通知，然后去更新自己的配置。</p></li></ol><h3 id="spring-cloud-bus" tabindex="-1"><a class="header-anchor" href="#spring-cloud-bus" aria-hidden="true">#</a> Spring cloud Bus</h3><h4 id="概述-6" tabindex="-1"><a class="header-anchor" href="#概述-6" aria-hidden="true">#</a> 概述</h4><ol><li><p>bus其实就是消息中间件，目前支持RabbitMQ、kafka</p><p><strong>是用来将分布式系统的节点（各个微服务）与轻量级消息系统链接起来的框架</strong>，它整合了Java的事件处理机制和消息中间件的功能。</p></li><li><p>springcloud config配合springcloud bus可以实现配置的动态刷新。</p></li><li><p>springcloud bus能管理和传播分布式系统间的消息，可以当作微服务间的通信通道。</p></li></ol><h4 id="通过bus实现全局广播" tabindex="-1"><a class="header-anchor" href="#通过bus实现全局广播" aria-hidden="true">#</a> 通过bus实现全局广播</h4><ol><li><p>再新建一个config客户端</p><p>用一个config center和两个config 客户端做测试，通过bus实现全局广播通知</p></li><li><p>pom文件、yml文件、主启动类和之前一样写就可以了，没有什么变化。</p></li><li><p>controller层的写法发生一点改变，添加了端口，因为此时要启动多个config client。</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;serverport:&quot;</span> <span class="token operator">+</span> serverPort <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;configInfo:&quot;</span> <span class="token operator">+</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="设计思想" tabindex="-1"><a class="header-anchor" href="#设计思想" aria-hidden="true">#</a> 设计思想</h4><ol><li>利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</li><li>利用消息总线触发一个服务端ConfigServer的/bus/refresh，而刷新所有客户端的配置。</li></ol><p>第二点的架构显然更加合理。</p><p>第一点不合适的原因如下：</p><ol><li>打破了微服务的职责单一性，客户端本来就是干活的，是业务模块，它本不应该承担配置刷新的职责。</li><li>破坏了微服务各节点的对等性</li><li>有一定的局限性， 例如微服务在迁移时，它的网络地址通常会发生变化，如果想通过客户端来做到自动刷新，那就会增加更多的修改，这样不合理。</li></ol><p>我们用的是第二种设计思想，由总控，由configServer来通知、来广播其他config client。</p><h4 id="设计实现" tabindex="-1"><a class="header-anchor" href="#设计实现" aria-hidden="true">#</a> 设计实现</h4><h5 id="cloud-config-center-3344配置中心服务端" tabindex="-1"><a class="header-anchor" href="#cloud-config-center-3344配置中心服务端" aria-hidden="true">#</a> cloud-config-center-3344配置中心服务端</h5><ol><li><p>给cloud-config-center-3344配置中心服务端添加消息总线支持</p><p>pom文件引入新的依赖</p><div class="language-xml ext-xml"><pre class="language-xml"><code>        <span class="token comment">&lt;!--添加消息总线rabbitmq支持--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>yml文件</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token comment">## rabbitmq相关配置</span>
<span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> 阿里云
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span>
<span class="token comment">#暴露bus刷新配置的端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&#39;bus-refresh&#39;</span>
</code></pre></div></li></ol><h5 id="config-client" tabindex="-1"><a class="header-anchor" href="#config-client" aria-hidden="true">#</a> config client</h5><ol><li><p>pom文件</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token comment">&lt;!--添加消息总线rabbitmq支持--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token comment">## rabbitmq相关配置</span>
<span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> 42.192.182.4
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span>
</code></pre></div></li></ol><h5 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h5><ol><li><p>修改配置</p></li><li><p>执行</p><div class="language-text ext-text"><pre class="language-text"><code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;
</code></pre></div><p>实现一次修改，一次发送，处处生效。</p><p>注意发送这个post请求，是对config server，对配置中心发送，不是对客户端微服务。</p><p>所以只需要发送一次，只刷一个config server，所有config client都被广播到，所有config client的配置都更新了。</p></li><li><p>效果</p><p>执行了上面那条指令之后，也就是刷新了3344config server的配置之后，不用重启项目，不用重启config server，也不用重启两个config client，分别刷新以下三个浏览器界面，可以看到配置更新</p><p><img src="/study/assets/image-20220422151353040.d8cb3d62.png" alt="image-20220422151353040"></p><p><img src="/study/assets/image-20220422151406381.c900dd5e.png" alt="image-20220422151406381"></p><p><img src="/study/assets/image-20220422151416281.3ba7586e.png" alt="image-20220422151416281"></p></li><li><p>我们是通过rabbitmq来实现广播通知的，原理就是客户端<strong>监听</strong>mq中的这个队列</p><p><img src="/study/assets/image-20220422151957201.a8f50731.png" alt="image-20220422151957201"></p></li></ol><h4 id="动态刷新定点通知" tabindex="-1"><a class="header-anchor" href="#动态刷新定点通知" aria-hidden="true">#</a> 动态刷新定点通知</h4><ol><li><p>比如只通知3355，不通知3366</p></li><li><p>指令</p><div class="language-text ext-text"><pre class="language-text"><code>curl -X POST &quot;http://localhost:配置中心的端口号/actuator/bus-refresh/{destination}&quot;
</code></pre></div><p>/bus/refresh请求不再发送到具体的服务实例上，而是发送给config server，并通过destination参数类<strong>指定需要更新配置的服务</strong></p><p>destination:</p><div class="language-text ext-text"><pre class="language-text"><code>spring.application.name:端口号
</code></pre></div></li></ol><h2 id="九、消息驱动" tabindex="-1"><a class="header-anchor" href="#九、消息驱动" aria-hidden="true">#</a> 九、消息驱动</h2><h3 id="spring-cloud-stream" tabindex="-1"><a class="header-anchor" href="#spring-cloud-stream" aria-hidden="true">#</a> spring cloud stream</h3><ol><li><p>为什么引入stream？</p><p>在一个完整的项目中，Java后端使用的mq和大数据部分使用的mq可能不是同一个mq，可能存在两种mq，那么就涉及到mq的切换、维护等。</p><p>引入stream，让我们不再关注具体MQ的细节，我们只需要用一种适配绑定的方式，自动在各种MQ内切换。</p></li><li><p>stream屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型。</p><p><strong>应用程序通过inputs或者outputs来与spring cloud stream中的binder对象交互</strong></p><p>通过我们配置来binding，而spring cloud stream的<strong>binder对象负责与消息中间件交互</strong></p></li></ol><h3 id="设计思想-1" tabindex="-1"><a class="header-anchor" href="#设计思想-1" aria-hidden="true">#</a> 设计思想</h3><ol><li><p>比方说我们用到了RabbitMQ和Kafka，由于这两个消息中间件的架构上的不同</p><p>像rabbitmq有exchange，kafka有topic和partitions分区的概念</p><p>现在用stream，来实现沟通，屏蔽差异，<strong>通过destination binder。</strong></p></li><li><p>如果我们先用了一种消息队列，后面的业务需求想往另一种消息队列进行迁移，那么这是灾难性的，因为原先的消息队列和我们的系统是耦合的，这时候springcloud stream给我们提供了一种解耦合的方式。</p></li><li><p>在没有绑定器这个概念的情况下，我们的springboot应用要直接与消息中间件进行信息交互的时候，由于各消息中间件构建的初衷不同，他们的实现细节会有较大的差异，<strong>通过定义绑定器binder作为中间层，完美地实现了应用程序与消息中间件细节之间的隔离。</strong></p><p><strong>通过向应用程序暴露统一的Channel通道，使得应用程序不再需要考虑各种不同的消息中间件实现</strong></p></li><li><p><strong>通过定义绑定器binder作为中间层，实现了应用程序与消息中间件细节的隔离。</strong></p><p><img src="/study/assets/image-20220422164048905.7dd5375c.png" alt="image-20220422164048905"></p><p>相当于消息队列中间件被绑定器挡在后面。</p><p>应用程序只需要和绑定器做交互。</p></li><li><p>stream中的消息通信方式遵循了发布-订阅模式</p></li></ol><h3 id="标准流程套路及注解" tabindex="-1"><a class="header-anchor" href="#标准流程套路及注解" aria-hidden="true">#</a> 标准流程套路及注解</h3><ol><li><p><img src="/study/assets/image-20220422173458808.2ad904ce.png" alt="image-20220422173458808"></p><p>binding很方便的连接消息中间件，屏蔽消息中间件的差异</p><p>channel是信道，在消息通讯系统中就是实现存储和转发的媒介，通过channel对队列进行配置。</p><p>source和sink，简单地可以理解为输入输出，从stream发布消息就是输出，<strong>接收消息就是输入。</strong></p></li><li><p>常用API和注解</p><p><img src="/study/assets/image-20220422174318322.0b819b44.png" alt="image-20220422174318322"></p></li></ol><h3 id="案例说明" tabindex="-1"><a class="header-anchor" href="#案例说明" aria-hidden="true">#</a> 案例说明</h3><h4 id="新建三个子module" tabindex="-1"><a class="header-anchor" href="#新建三个子module" aria-hidden="true">#</a> 新建三个子module</h4><ul><li>cloud-stream-rabbitmq-provider8801，作为生产者进行发消息模块</li><li>cloud-stream-rabbitmq-consumer8802，作为消息接收模块</li><li>cloud-stream-rabbitmq-consumer8803，作为消息接收模块</li></ul><h4 id="生产者" tabindex="-1"><a class="header-anchor" href="#生产者" aria-hidden="true">#</a> 生产者</h4><ul><li><p>pom</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--stream--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--监控--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--热部署--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8801</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>provider
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 阿里云
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment">#在此处配置要绑定的rabbitmq的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment">#表示定义的名称，用于binding整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment">## 消息组件类型</span>
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment">## 服务的绑定，整合</span>
        <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token comment">#表示这是服务的生产者</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment">#表示要使用的Exchange名称</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment">#设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">#设置心跳的时间间隔（默认是30秒）</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> send<span class="token punctuation">-</span>8801.com <span class="token comment">#在信息列表显示主机名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#访问的路径变为ip地址</span>
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamMQMain8801</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">StreamMQMain8801</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>业务类</p><p>发送消息接口</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>发送消息接口实现类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">//通过此注解定义消息生产者的发送管道(是源，source),channel和exchange绑定</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IMessageProviderImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageChannel</span> output<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> serial <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;***serial: &quot;</span> <span class="token operator">+</span> serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>Controller</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IMessageProvider</span> iMessageProvider<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sendMessage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> iMessageProvider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul><h4 id="消费者" tabindex="-1"><a class="header-anchor" href="#消费者" aria-hidden="true">#</a> 消费者</h4><ul><li><p>pom文件和生产者一样</p></li><li><p>application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8802</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 阿里云
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment">#在此处配置要绑定的rabbitmq的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment">#表示定义的名称，用于binding整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment">## 消息组件类型</span>
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment">## 服务的绑定，整合</span>
        <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment">#表示这是服务的消费者</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment">#表示要使用的Exchange名称</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment">#设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">#设置心跳的时间间隔（默认是30秒）</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> receive<span class="token punctuation">-</span>8801.com <span class="token comment">#在信息列表显示主机名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#访问的路径变为ip地址</span>
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamMQMain8802</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">StreamMQMain8802</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p><strong>消费者业务类</strong></p><p>由于这是微服务，这是消费者，是消费消息的，就不写什么service业务层了，只写controller层来测试一下（但是要注意在实际开发中，一个微服务可能既是服务提供者，也是服务消费者，同时针对于消息队列，一个微服务可能既是消息生产者，也是消息的消费者。）</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessageListenerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1,-----&gt;接收到的消息 &quot;</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;serverPort: &quot;</span> <span class="token operator">+</span> serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要注意仍然用到@EnableBinding这个注解，只不过括号里的是消费端的Sink.class</p></li><li><p>总结：</p><p>消费者端用以下两个注解：</p><ul><li>@EnableBinding(Sink.class)</li><li>@StreamListener(Sink.INPUT)</li></ul><p>生产者用以下注解：</p><ul><li>@EnableBinding(Source.class)</li></ul></li></ul><h3 id="分组消费" tabindex="-1"><a class="header-anchor" href="#分组消费" aria-hidden="true">#</a> 分组消费</h3><ol><li><p>再写一个消费者module，端口号8803</p></li><li><p>运行后有两个问题：</p><ul><li><p>重复消费</p><p>生产者发送消息，目前是8802和8803都收到了，存在重复消费问题。</p><p>如果一个订单同时被两个消费者获取到，那么会造成数据错误，因为消费者消费到消息，那么是要对消息做处理的，就会有两个消费者对同一条消息进行处理，所以要避免这个问题</p><p><img src="/study/assets/image-20220422205146287.0b59800d.png" alt="image-20220422205146287"></p><p>导致原因：不同消费者微服务（应用程序）默认分组是不同的。</p></li><li><p>消息持久化问题</p></li></ul></li><li><p>解决重复消费问题：</p><p>用stream中的消息分组来解决。</p><p>注意Stream中处于<strong>同一个group中的多个消费者是竞争关系，就能够保证消息只会被其中一个应用消费一次。</strong></p><p>不同组是全面消费的（重复消费）</p><p>如果没有手动做分组的话，默认每一个消费者微服务（应用程序）的组都不一样，不同的组都要把消息消费一次，导致了重复消费。</p><p>现在自定义配置分组，自定义配置分为同一个组，解决重复消费问题</p></li><li><p>自定义配置分组</p><p>原理：微服务应用放置于同一个group中，就能够保证消息只被组中其中一个消费者消费一次。</p><p>不同的组是可以重复消费的，但是同一个组内会发生竞争关系，只有其中一个可以消费。</p><p>自定义配置分组就是在yml文件中配置，如下：</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment">## 服务的绑定，整合</span>
  <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment">#表示这是服务的消费者</span>
    <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment">#表示要使用的Exchange名称</span>
    <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment">#设置消息类型，本次为json，文本则设置“text/plain”</span>
    <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit
    <span class="token key atrule">group</span><span class="token punctuation">:</span> atguiguB
</code></pre></div><p>现在要实现每次只有一个消费者消费消息，8801模块发送的消息只能被8802或者8803其中一个接收到，这样就避免了重复消费。</p><p>那么把两个消费者配置成相同组。</p><p>把两个消费者都配置成<code>atguiguB</code>组</p><p>效果如下：</p><p>8801发送6条消息</p><div class="language-text ext-text"><pre class="language-text"><code>***serial: c5f4370d-a3f0-4303-93fd-6c3dee0e4df1
***serial: a2d90834-4b5a-4219-8588-4e64dabee641
***serial: afe5fb00-c5a7-4ee7-9e7f-d02fa801886f
***serial: b4450607-12ff-4323-a516-4f70b6749ea7
***serial: 6a3d5224-6871-4ca9-ba3e-4c2daddd0583
***serial: 3e891ece-bcc2-4931-a4b9-31f8fb59b6b8
</code></pre></div><p>8802和8803两个消费者微服务轮询接收消息</p><p>8802</p><div class="language-text ext-text"><pre class="language-text"><code>消费者1,-----&gt;接收到的消息 c5f4370d-a3f0-4303-93fd-6c3dee0e4df1	serverPort: 8802
消费者1,-----&gt;接收到的消息 afe5fb00-c5a7-4ee7-9e7f-d02fa801886f	serverPort: 8802
消费者1,-----&gt;接收到的消息 6a3d5224-6871-4ca9-ba3e-4c2daddd0583	serverPort: 8802
</code></pre></div><p>8803</p><div class="language-text ext-text"><pre class="language-text"><code>消费者2,-----&gt;接收到的消息 a2d90834-4b5a-4219-8588-4e64dabee641	serverPort: 8803
消费者2,-----&gt;接收到的消息 b4450607-12ff-4323-a516-4f70b6749ea7	serverPort: 8803
消费者2,-----&gt;接收到的消息 3e891ece-bcc2-4931-a4b9-31f8fb59b6b8	serverPort: 8803
</code></pre></div></li></ol><h3 id="持久化" tabindex="-1"><a class="header-anchor" href="#持久化" aria-hidden="true">#</a> 持久化</h3><ol><li><p>消息持久化问题：</p><ul><li><p>停止8802消费者和8803消费者</p></li><li><p>8802消费者的分组被去掉，8803的分组不去掉，那么现在8802消费者是没有持久化的，但是8803消费者是持久化。</p></li><li><p>此时8801发送4条消息到rabbitmq</p></li><li><p>先启动8802，无分组属性配置，后台没有打出来消息</p></li><li><p>再启动8803，有分组属性配置，后台打出来了MQ上的消息。</p></li></ul></li><li><p>group属性在避免消费者重复消费，和消息持久化，避免消息丢失上有着重要的作用。</p></li></ol><h2 id="spring-cloud-alibaba" tabindex="-1"><a class="header-anchor" href="#spring-cloud-alibaba" aria-hidden="true">#</a> Spring Cloud Alibaba</h2><p><a href="https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/README-zh.md" target="_blank" rel="noopener noreferrer">spring-cloud-alibaba/README-zh.md at 2.2.x · alibaba/spring-cloud-alibaba (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</p><ol><li>大致作用： <ul><li>服务限流降级</li><li>服务注册与发现---eureka、zookeeper、consul等的作用</li><li>分布式配置管理</li><li>消息驱动能力</li><li>阿里云对象存储</li><li>分布式任务调度</li></ul></li></ol><h2 id="十、nacos" tabindex="-1"><a class="header-anchor" href="#十、nacos" aria-hidden="true">#</a> 十、Nacos</h2><h3 id="概述-7" tabindex="-1"><a class="header-anchor" href="#概述-7" aria-hidden="true">#</a> 概述</h3><ol><li><p>nacos是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台</p><p>nacos就是注册中心 + 配置中心的组合。</p><p>替代eureka做注册中心，替代spring cloud config做配置中心</p></li></ol><h3 id="nacos做注册中心" tabindex="-1"><a class="header-anchor" href="#nacos做注册中心" aria-hidden="true">#</a> nacos做注册中心</h3><h4 id="服务提供者" tabindex="-1"><a class="header-anchor" href="#服务提供者" aria-hidden="true">#</a> 服务提供者</h4><ol><li><p>建module</p></li><li><p>改pom</p><div class="language-xml ext-xml"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--热部署--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>


<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&#39;*&#39;</span>
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain9001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain9001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>业务类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/payment/nacos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;nacos registry, serverPort: &quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;id: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h4 id="服务消费者" tabindex="-1"><a class="header-anchor" href="#服务消费者" aria-hidden="true">#</a> 服务消费者</h4><ol><li><p>同样的方式建module、改pom，写application.yml，主启动类，以及业务类，进行服务的远程调用。</p><p>服务的远程调用可以通过openFeign，知道服务名，从注册中心进行服务发现，进而进行服务调用。</p><p>可以通过Ribbon+RestTemplate</p></li><li><p>为什么nacos自带负载均衡？</p><p>nacos集成了netflix的ribbon，ribbon是支持负载均衡的。</p><p><img src="/study/assets/image-20220427192401949.74683871.png" alt="image-20220427192401949"></p></li><li><p>pom文件和服务提供者一样</p></li><li><p>application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">83</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>order<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>

<span class="token comment">#消费者将要去访问的微服务提供者的服务名称（注册进nacos的服务提供者）</span>
<span class="token key atrule">service-url</span><span class="token punctuation">:</span>
  <span class="token key atrule">nacos-user-service</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
</code></pre></div></li><li><p>主启动类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderNacosMain83</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderNacosMain83</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p>因为nacos自带ribbon，所以我们要写RestTemplate的配置类</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol><h3 id="nacos做配置中心" tabindex="-1"><a class="header-anchor" href="#nacos做配置中心" aria-hidden="true">#</a> nacos做配置中心</h3><h4 id="概述-8" tabindex="-1"><a class="header-anchor" href="#概述-8" aria-hidden="true">#</a> 概述</h4><ol><li><p>以前是通过springcloud config作为配置中心。</p><p>结合springcloud bus实现动态刷新配置，不用重启服务。</p><p>配置通过github来存储，并且实现配置的动态刷新。</p><p>现在是通过nacos来完成这一功能</p></li></ol><h4 id="基础配置" tabindex="-1"><a class="header-anchor" href="#基础配置" aria-hidden="true">#</a> 基础配置</h4><ol><li><p>新建module</p></li><li><p>pom</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>配置文件要写bootstrap.yml和application.yml两个</p><p>nacos和springcloud-config一样，在项目初始化的时候，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动。</p><p>springboot中的配置文件加载是存在优先级的，bootstrap要高于application</p><p><strong>相当于先有共性，后有个性</strong></p><p>bootstrap.yml:</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
</code></pre></div><p>application.yml:</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment">#表示开发环境</span>
</code></pre></div></li><li><p>Controller</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 支持Nacos的动态刷新功能</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/config/info&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li><li><p><img src="/study/assets/image-20220427221615036.08db776a.png" alt="image-20220427221615036"></p></li></ol><h4 id="分类配置" tabindex="-1"><a class="header-anchor" href="#分类配置" aria-hidden="true">#</a> 分类配置</h4><ol><li><p>nacos的namespace是可以用于区分部署环境的，group和dataID逻辑上区分两个目标对象。</p><p><img src="/study/assets/image-20220427223205012.8d83f656.png" alt="image-20220427223205012"></p><p>比如说我们现在有三个环境：开发、测试和生产，我们就可以创建三个namespace，不同的namespace之间是隔离的。</p><p>一个namespace下面可以进行多个group分组。</p><p>group可以把不同的微服务划分到同一个分组里。</p></li><li><p>命名空间namespace：配置隔离</p><ul><li><p>默认：public（保留空间），默认新增的所有配置都在public空间</p></li><li><p>开发、测试、生产：利用命名空间做环境隔离</p><p>要同时在bootstrap.yml中对namespace进行配置</p></li><li><p>每一个微服务之间互相隔离配置，<strong>每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置。</strong></p></li></ul></li><li><p>配置分组：</p><p>默认所有的配置集都属于：DEFAULT_GROUP</p><p>一个namespace下面可以进行多个group分组。</p><p>比如说某一个微服务，针对618、双11可以设置不同的分组。<strong>618、1111是同一个namespace下的多个group</strong></p></li><li><p>分组配置如下：</p><p><img src="/study/assets/image-20220427224110964.47cf1505.png" alt="image-20220427224110964"></p><p><img src="/study/assets/image-20220427224143741.3feb690c.png" alt="image-20220427224143741"></p></li><li><p>通过namespace来区分配置环境</p><ul><li><p>修改bootstrap.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">group</span><span class="token punctuation">:</span> DEV_GROUP
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> f0d42ed7<span class="token punctuation">-</span>6cba<span class="token punctuation">-</span>4fe0<span class="token punctuation">-</span>be60<span class="token punctuation">-</span>5e802b16886d
</code></pre></div></li></ul></li></ol><h3 id="nacos集群和持久化配置" tabindex="-1"><a class="header-anchor" href="#nacos集群和持久化配置" aria-hidden="true">#</a> nacos集群和持久化配置</h3><h4 id="概述-9" tabindex="-1"><a class="header-anchor" href="#概述-9" aria-hidden="true">#</a> 概述</h4><ol><li><p>nacos上一些重要的信息需要持久化，只是把信息配置进nacos里面，可能还不够，需要配置到数据库里，推荐的数据库是mysql，所以要进行linux的mysql安装配置</p></li><li><p><img src="/study/assets/image-20220427232304944.f6fcd8c1.png" alt="image-20220427232304944"></p></li><li><p>nacos在没有配置mysql数据之前，自带了一个内嵌式数据库。</p><p>内存中的东西，一断电就没有了，存入数据库，存入磁盘，才是持久化。</p></li><li><p>如果启动多个默认配置下的nacos节点，每个nacos都自带一份自己的小的嵌入式数据库derby，数据存储是存在一致性问题的，为了解决这个问题，nacos采用了集中式存储的方式来支持集群化部署，目前只支持mysql，保证了数据一致性。</p><p>我们需要使nacos不再使用它自带的嵌入式数据库，而应配置MySQL，使用MySQL。</p></li></ol><h4 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h4><ol><li><p>需要1个nginx，3个nacos，1个mysql</p></li><li><p>在linux服务器上安装mysql和nginx，这不是本章的重点，重点在于三者之间的配置，建立起他们之间的联系。</p></li><li><p>安装nacos linux版本。</p></li><li><p>mysql配置步骤</p><ul><li><p>找到nacos的安装路径下的conf目录的nacos-mysql.sql文件</p><p>这是sql语句源文件，是在nacos中进行mysql配置的。</p></li><li><p>在linux服务器上的mysql，新建数据库nacos_config</p></li><li><p>执行命令<code>use nacos_config;</code></p></li><li><p>复制nacos-mysql.sql文件中的全部sql语句执行。</p></li></ul></li><li><p>conf目录下的application.properties配置</p><div class="language-properties ext-properties"><pre class="language-properties"><code><span class="token key attr-name">spring.datasource.platform</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>

<span class="token key attr-name">db.num</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token key attr-name">db.url.0</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://aliyun:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span>
<span class="token key attr-name">db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">db.password</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>
</code></pre></div></li><li><p>linux服务器上，nacos集群配置cluster.conf（conf目录下）</p><ul><li><p>先用<code>hostname -I</code>查询服务器ip地址</p><div class="language-text ext-text"><pre class="language-text"><code>[root@VM-0-2-centos conf]## hostname -I
172.17.0.2 
</code></pre></div></li><li><p>配置</p><div class="language-text ext-text"><pre class="language-text"><code>172.17.0.2:3333
172.17.0.2:4444
172.17.0.2:5555
</code></pre></div></li><li><p>经过以上两个步骤，配置好了nacos的集群，通过不同端口启动。</p></li><li><p>编辑nacos的启动脚本startup.sh，使它能够接受不同的启动端口</p><p>bin目录下有startup.sh</p><p>第一步</p><p><img src="/study/assets/image-20220428184814381.b91e2f3e.png" alt="image-20220428184814381"></p><p>第二步</p><p><img src="/study/assets/image-20220428184927825.02eed2e4.png" alt="image-20220428184927825"></p></li></ul></li><li><p>nginx配置</p><ul><li><p>修改nginx配置文件</p><div class="language-conf ext-conf"><pre class="language-conf"><code>#gzip  on;
upstream cluster{
    server 127.0.0.1:3333;
    server 127.0.0.1:4444;
    server 127.0.0.1:5555;
}

server {
    listen       1111;
    server_name  localhost;

    #charset koi8-r;

    #access_log  logs/host.access.log  main;

    location / {
       ## root   html;
       ## index  index.html index.htm;
       proxy_pass http://cluster;
    }
</code></pre></div></li></ul></li><li><p>测试通过nginx访问linux上的nacos集群</p><p>nacos的集群，三个nacos服务的端口分别是3333、4444、5555</p><p>但是现在不直接访问，通过nginx进行访问，nginx配置好的端口号是1111</p><p>分别启动三个nacos服务</p><div class="language-text ext-text"><pre class="language-text"><code> ./startup.sh -p 3333
 ./startup.sh -p 4444
 ./startup.sh -p 5555
</code></pre></div><p>启动nginx</p><div class="language-text ext-text"><pre class="language-text"><code>./nginx -c /usr/local/nginx/conf/nginx.conf
</code></pre></div><p>访问<code>http://42.192.182.4:1111/nacos/#/login</code></p><p><img src="/study/assets/image-20220428191323625.4581e964.png" alt="image-20220428191323625"></p><p>发布配置</p><p><img src="/study/assets/image-20220428191620215.2fa15300.png" alt="image-20220428191620215"></p><p>检查mysql</p><p><img src="/study/assets/image-20220428191752846.1f2cc21d.png" alt="image-20220428191752846"></p><p>微服务进行注册</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment">#server-addr: localhost:8848</span>
        <span class="token comment">#改成linux服务器上nginx的地址，通过nginx进行转发，服务器上有3个nacos服务，通过nginx做负载均衡</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 42.192.182.4<span class="token punctuation">:</span><span class="token number">1111</span>
</code></pre></div></li></ol><h2 id="sentinel实现熔断与限流" tabindex="-1"><a class="header-anchor" href="#sentinel实现熔断与限流" aria-hidden="true">#</a> Sentinel实现熔断与限流</h2><h3 id="概述-10" tabindex="-1"><a class="header-anchor" href="#概述-10" aria-hidden="true">#</a> 概述</h3><ol><li><p>相当于hystrix的阿里版，做微服务，分布式系统的流量控制、熔断降级。</p></li><li><p><a href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">介绍 · alibaba/Sentinel Wiki (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>作用：</p><p>防止服务雪崩</p><p>做服务降级</p><p>服务熔断</p><p>服务限流</p></li><li><p>sentinel分为两个部分</p><ul><li>核心库（Java客户端）：不依赖任何框架、库，能够运行于所有的Java运行时环境，同时对Dubbo、springcloud等框架也有较好的支持。</li><li>控制台（Dashboard）：基于springboot开发，打包后可以直接运行，不需要额外的tomcat等容器。</li></ul></li></ol><h3 id="微服务集成sentinel" tabindex="-1"><a class="header-anchor" href="#微服务集成sentinel" aria-hidden="true">#</a> 微服务集成sentinel</h3><ol><li><p>新建module</p></li><li><p>改pom</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--nacos config 和 discovery--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--sentinel--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--后续做持久化用到--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--子类没有写版本号的，都继承了父类的版本号--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--监控--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--热部署--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li><li><p>application.yml</p><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8401</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token comment">## nacos服务注册中心地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token comment">#配置sentinel dashboard地址</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token comment">## 默认8719端口，假如被占用会自动从8719开始+1扫描，直至找到未被占用的端口</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&#39;*&#39;</span>
</code></pre></div></li></ol><h3 id="流控规则" tabindex="-1"><a class="header-anchor" href="#流控规则" aria-hidden="true">#</a> 流控规则</h3><ol><li><p>介绍</p><ul><li><p>资源名：唯一名称，默认请求路径</p></li><li><p>针对来源：sentinel可以针对调用者进行限流，填写微服务名称，默认default（不区分来源）</p></li><li><p>阈值类型/单机阈值：</p><ul><li>QPS（<strong>每秒钟的请求数量</strong>）：当调用该api的QPS达到阈值的时候，进行限流</li><li>线程数：当调用该API的线程数达到阈值的时候，进行限流。</li></ul></li><li><p>是否集群：不需要集群</p></li><li><p>流控模式：</p><ul><li><p>直接：api达到限流条件时，直接限流</p></li><li><p>关联：当关联的资源达到阈值时，限流自己</p><p>当与A关联的资源B达到阈值后，就限流A自己</p><p><img src="/study/assets/image-20220428235324056.79f162bd.png" alt="image-20220428235324056"></p></li><li><p>链路：只记录链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）</p></li></ul></li><li><p>流控效果：</p><ul><li><p>快速失败：直接抛异常</p></li><li><p>warm up：</p><p>即预热/冷启动方式，当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮，通过冷启动，<strong>让通过的流量缓慢增加</strong>，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p><p>默认冷加载因子是3，<strong>即请求QPS从阈值/3开始，经预热时长逐渐升至设定的QPS阈值，相当于给系统一个预热缓冲的时间，请求限制阈值刚开始很低，经预热时长，才逐渐达到设定阈值。</strong></p><p><img src="/study/assets/image-20220429000459359.3e44b670.png" alt="image-20220429000459359"></p></li><li><p>排队等待：匀速排队，让请求匀速通过，阈值类型必须设置为QPS，否则无效。</p><p><img src="/study/assets/image-20220429000950900.4d890588.png" alt="image-20220429000950900"></p><p>这种方式主要用于处理间隔性突发的流量，例如消息队列。例如这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间<strong>逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</strong></p></li></ul></li></ul></li></ol><h3 id="熔断降级" tabindex="-1"><a class="header-anchor" href="#熔断降级" aria-hidden="true">#</a> 熔断降级</h3><ol><li><p><img src="/study/assets/image-20220429005351780.edeb1a66.png" alt="image-20220429005351780"></p></li><li><p>RT：平均响应时间</p><p>时间窗口内通过的请求&gt;=5，且平均响应时间均超过阈值，触发降级，<strong>接下来的时间窗口，对这个方法的调用，都自动地进行熔断。</strong></p><p>窗口期过后，关闭断路器。</p><p><img src="/study/assets/image-20220429010249375.f254d54d.png" alt="image-20220429010249375"></p></li><li><p>异常比例：</p><p>QPS &gt;= 5，且异常比例（秒级统计），超过阈值时，触发降级（接下来的时间窗口）；时间窗口结束后，关闭降级。</p></li><li><p>异常数</p><p>分钟统计，超过阈值，触发降级（接下来的时间窗口），时间窗口结束后，关闭降级。</p></li><li><p>sentinel的断路器是没有半开状态的。</p></li><li><p>sentinel熔断降级会在调用链路中某个资源出现不稳定状态（以上三种情况）时，对这个资源的调用进行限制，让请求快速失败，避免影响到其他的资源而导致级联错误。</p><p>当资源被降级后，在接下来的窗口时间内，对该资源的调用都自动熔断。</p></li></ol><h3 id="热点规则" tabindex="-1"><a class="header-anchor" href="#热点规则" aria-hidden="true">#</a> 热点规则</h3><ol><li><p>何为热点？</p><p>热点就是经常访问的数据</p><p><img src="/study/assets/image-20220429012930432.f2927921.png" alt="image-20220429012930432"></p></li><li><p>之前的case，服务熔断降级后，或者服务限流了，都是用sentinel系统默认的提示，这个提示是可以自定义的，类似于hystrix兜底的方法，即fallback method</p><p>通过注解</p><p>从@HystrixCommand到@SentinelResource</p><p><img src="/study/assets/image-20220429013822810.d1fe4a7a.png" alt="image-20220429013822810"></p><p><img src="/study/assets/image-20220429014054421.03d4198f.png" alt="image-20220429014054421"></p><p><strong>注意：资源名，不带斜线，说明是配置的@SentinelResource注解的value值，限流信息是根据我们自定义的方法，即@SentinelResource注解的blockHandler的值，若带斜线，说明是根据url地址进行限流，限流信息是sentinel的默认信息</strong></p><p>blockHandler相当于是@HystrixCommand注解的fallbackmethod</p><p>以上配置的意思是：1秒钟之内，请求次数超过1了，即QPS超过1，那么会执行blockHandler的自定义方法，相当于fallbackmethod，实现服务降级。</p></li><li><p>参数例外项</p><p>普通的配置就是，当带有某个参数的请求的QPS超过阈值，被限流，执行blockHandler的自定义方法</p><p>但是我们期望设定的参数是某个特殊值时，它的限流值和平时不一样。假如当p1的值是5时，阈值可以是200.</p><p><img src="/study/assets/image-20220429014913106.17a9453d.png" alt="image-20220429014913106"></p></li><li><p>注意：</p><p><img src="/study/assets/image-20220429015602259.f8ddb78d.png" alt="image-20220429015602259"></p></li></ol><h3 id="sentinelresource" tabindex="-1"><a class="header-anchor" href="#sentinelresource" aria-hidden="true">#</a> @SentinelResource</h3><ol><li><p>这个注解的blockHandler属性，请求会根据sentinel配置的流控规则，跳转到blockHandler的方法进行执行，相当于Hystrix的fallback method，但是当调用的方法内部出现了异常，并不会跳转到blockHandler的方法执行，而是会报异常，只会根据sentinel的配置进行跳转</p><p><strong>如果是调用的方法内部出现了异常，又不想页面抛出异常，而是通过对应的方法进行处理，那么需要另外配置fallback属性。</strong></p></li><li><p>兜底方案面临的问题</p><ul><li>我们自定义的处理方法和业务代码耦合在一起</li><li>每个业务方法都添加一个兜底的，代码膨胀</li><li>全局统一的处理方法没有体现</li></ul></li><li><p>解决上述问题</p><ul><li><p>创建CustomBlockHandler类用于自定义限流处理逻辑，在这个类里统一处理跳转页面、服务降级的说明等等，来统一写限流的相关信息，将限流、降级与业务代码解耦</p><div class="language-java ext-java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomBlockHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> blockException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">4444</span><span class="token punctuation">,</span> <span class="token string">&quot;按客户自定义,global handlerException---1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerException2</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> blockException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">4444</span><span class="token punctuation">,</span> <span class="token string">&quot;按客户自定义,global handlerException---2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java ext-java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RateLimitController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/rateLimit/customBlockHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;customBlockHandler&quot;</span><span class="token punctuation">,</span> blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;handlerException2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">customBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;按客户自定义&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token number">2020L</span><span class="token punctuation">,</span> <span class="token string">&quot;serial003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><img src="/study/assets/image-20220429154831580.8452e50e.png" alt="image-20220429154831580"></p></li></ul></li><li><p>重要属性：</p><ul><li><p>value：资源名称：必需项</p></li><li><p>blockHandler/blockHandlerClass:</p><p><strong>blockHandler对应处理BlockException的函数名称</strong>，可选项。</p><p>blockHandler函数访问范围必须是public，返回类型需要与原业务方法相匹配，参数类型需要和原业务方法相匹配并且最后加一个额外的参数，类型为<strong>BlockException</strong>。blockHandler函数默认需要和原方法在同一个类中，若希望使用其他类的函数，则可以指定blockHandlerClass为对应的类class对象，<strong>注意对应的函数必须为static函数，否则无法解析。</strong></p></li><li><p>fallback：可选项，用于在抛出异常的时候提供fallback处理逻辑。fallback函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。</p><p>fallback函数签名和位置要求：</p><ul><li>返回值类型必须和原业务方法返回值类型一致。</li><li>方法参数列表需要和原函数一致，或者可以额外多一个<strong>Throwable</strong>类型的参数用于接收对应的异常。</li><li>fallback函数默认需要和原方法在同一个类中，若希望使用其他类的函数（使处理异常的代码和业务逻辑代码解耦合），则可以指定fallbackClass为对应的类的class对象，<strong>注意到对应的函数必须为staic函数，否则无法解析。</strong></li></ul></li></ul></li></ol><h3 id="服务熔断功能" tabindex="-1"><a class="header-anchor" href="#服务熔断功能" aria-hidden="true">#</a> 服务熔断功能</h3><ol><li><p>@SentinelResource的属性</p><ul><li>fallback管运行异常</li><li>blockHandler管配置违规</li></ul><p>若blockHandler和fallback都进行了配置，则被限流降级而抛出BlockException时只会进入blockHandler处理逻辑。</p></li><li><p>异常忽略</p><p><img src="/study/assets/image-20220429164904026.4bfd3aa5.png" alt="image-20220429164904026"></p></li></ol><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 64005626+shaileneF@users.noreply.github.com">shailene</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/study/assets/app.dca8cb27.js" defer></script>
  </body>
</html>
